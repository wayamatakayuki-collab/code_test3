<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>休暇時間計算（事務向け：職員別・月別・年度別／種別カスタム）</title>

  <link rel="apple-touch-icon" href="icon-180.png">
  <link rel="icon" type="image/png" href="icon-180.png">

  <style>
    :root{
      --bg:#f7f7fb;
      --card:#ffffff;
      --ink:#111827;
      --muted:#6b7280;
      --brand:#2563eb;
      --brand2:#1d4ed8;
      --danger:#ef4444;
      --ok:#10b981;
      --ring: 0 0 0 3px rgba(37,99,235,.18);
      --radius: 18px;
      --radius2: 14px;
      --shadow: 0 18px 40px rgba(2,6,23,.08), 0 2px 8px rgba(2,6,23,.06);
      --line:#e5e7eb;
      --soft:#f3f4f6;
      --soft2:#f8fafc;

      /* ★統一コントロール高さ */
      --controlH: 44px;
      --controlPadY: 10px;
      --controlPadX: 12px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN","Yu Gothic UI","Noto Sans JP", sans-serif;
      color: var(--ink);
      background: radial-gradient(900px 600px at 10% -10%, rgba(37,99,235,.10), transparent 60%),
                  radial-gradient(900px 600px at 95% 0%, rgba(16,185,129,.10), transparent 55%),
                  linear-gradient(180deg, var(--bg) 0%, #ffffff 70%, var(--bg) 100%);
      padding: 18px;
    }

    .app{
      width:min(1400px, 100%);
      margin:0 auto;
      background: var(--card);
      border:1px solid var(--line);
      border-radius: 22px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    header{
      padding: 16px 18px 12px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, #ffffff 0%, #fbfbfe 100%);
    }
    .topbar{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    header h1{
      margin:0;
      font-size: clamp(18px, 2.6vw, 22px);
      letter-spacing:.2px;
      font-weight: 900;
    }
    .subtitle{color:var(--muted); font-size:12px; margin-top:4px; line-height:1.45}
    .badge{
      margin-left:auto;
      display:inline-flex; gap:8px; align-items:center;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: #f8fafc;
      color: var(--ink);
      font-weight:800;
      font-size:12px;
      white-space:nowrap;
    }
    .badge .dot{width:10px;height:10px;border-radius:999px;background:var(--brand)}
    .wrap{padding: 14px 14px 18px}

    .grid{
      display:grid;
      grid-template-columns: 1.05fr 1fr;
      gap: 14px;
      align-items:start;
    }

    /* ★設定タブ時：左を消して右を広く */
    body.settingsMode .grid{ grid-template-columns: 1fr; }
    body.settingsMode #inputPanel{ display:none !important; }

    .card{
      border:1px solid var(--line);
      background: #fff;
      border-radius: var(--radius);
      overflow:hidden;
    }
    .card .cardHead{
      padding: 12px 14px;
      border-bottom:1px solid var(--line);
      background: var(--soft2);
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .card .cardHead .title{font-weight: 950; letter-spacing:.2px}
    .card .cardHead .meta{color: var(--muted); font-size: 12px; margin-left:auto; white-space:nowrap}
    .card .cardBody{padding: 14px}

    .field label{
      font-size:12px;
      color: var(--muted);
      display:block;
      margin: 0 0 7px;
      font-weight: 800;
      letter-spacing:.15px;
    }

    input[type=number], input[type=text], input[type=date], input[type=month], select{
      width:100%;
      border:1px solid var(--line);
      border-radius: 14px;
      padding: var(--controlPadY) var(--controlPadX);
      font-size:16px;
      outline:none;
      color: var(--ink);
      background: #fff;
      height: var(--controlH);
      line-height: 1.2;
    }
    /* ★selectの見た目・高さ安定（Safari対策） */
    select{
      -webkit-appearance: none;
      appearance: none;
      background-image:
        linear-gradient(45deg, transparent 50%, #64748b 50%),
        linear-gradient(135deg, #64748b 50%, transparent 50%),
        linear-gradient(to right, transparent, transparent);
      background-position:
        calc(100% - 18px) calc(50% - 3px),
        calc(100% - 12px) calc(50% - 3px),
        0 0;
      background-size:
        6px 6px,
        6px 6px,
        100% 100%;
      background-repeat: no-repeat;
      padding-right: 34px;
    }

    input::placeholder{color:#9ca3af}
    input:focus, select:focus{border-color: var(--brand); box-shadow: var(--ring);}

    .row{display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap}
    .group{display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; align-items:end}
    .divider{height:1px; background: var(--line); margin: 12px 0}

    button{
      appearance:none; border:0; cursor:pointer;
      padding: 11px 14px;
      border-radius: 14px;
      font-size: 14px;
      font-weight: 900;
      letter-spacing:.15px;
      color: #fff;
      background: linear-gradient(180deg, #3b82f6 0%, #2563eb 100%);
      box-shadow: 0 12px 24px rgba(37,99,235,.16);
      transition: transform .05s ease, filter .15s ease, opacity .15s ease;
      min-height: var(--controlH);
    }
    button:hover{filter:brightness(1.03)}
    button:active{transform: translateY(1px)}
    button.secondary{
      color: var(--ink);
      background: #fff;
      border:1px solid var(--line);
      box-shadow:none;
    }
    button.ghost{
      color: var(--brand);
      background: transparent;
      border:1px solid rgba(37,99,235,.35);
      box-shadow:none;
    }
    button.ok{
      color:#064e3b;
      background: linear-gradient(180deg, #34d399 0%, #10b981 100%);
      box-shadow: 0 12px 24px rgba(16,185,129,.14);
    }
    button.danger{
      color:#fff;
      background: linear-gradient(180deg, #fb7185 0%, #ef4444 100%);
      box-shadow: 0 12px 24px rgba(239,68,68,.14);
    }
    button:disabled{opacity:.55; cursor:not-allowed; transform:none}

    .actions{display:flex; gap:10px; flex-wrap:wrap}
    .actions .full{flex:1 1 260px}

    .miniRow{display:flex; gap:8px; flex-wrap:wrap}
    .miniBtn{
      padding: 9px 12px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 950;
      color: var(--ink);
      background: #fff;
      border: 1px solid var(--line);
      box-shadow:none;
      min-height: unset;
    }

    .kpiGrid{display:grid; grid-template-columns: 1fr 1fr; gap: 10px}
    .kpiCard{
      border:1px solid var(--line);
      background: #fff;
      border-radius: 16px;
      padding: 12px;
    }
    .kpiCard .t{color:var(--muted); font-size:12px; font-weight:900}
    .kpiList{margin-top:10px; display:grid; gap:8px}
    .kpiItem{
      display:flex; justify-content:space-between; gap:10px; align-items:center;
      border:1px solid var(--line);
      background: var(--soft2);
      padding: 9px 10px;
      border-radius: 14px;
      font-size: 13px;
    }
    .kpiItem .left{display:flex; gap:10px; align-items:center; min-width:0}
    .kpiItem .name{font-weight:950; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .kpiItem b{font-weight:950}
    .dot2{width:10px;height:10px;border-radius:999px;background:#94a3b8; flex:0 0 auto}

    .chips{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .chip{
      display:inline-flex; gap:8px; align-items:center;
      padding: 8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: #fff;
      font-size: 12px;
      color: var(--muted);
      font-weight: 900;
    }
    .chip strong{color: var(--ink); font-weight: 950}

    .noteBox{
      margin-top: 10px;
      border:1px solid var(--line);
      background: var(--soft2);
      border-radius: 16px;
      padding: 10px 12px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.6;
    }

    /* Tabs */
    .tabs{
      display:flex; gap:8px; flex-wrap:wrap;
      padding: 10px;
      border:1px solid var(--line);
      background: #fff;
      border-radius: 999px;
    }
    .tab{
      border:1px solid transparent;
      background: transparent;
      color: var(--muted);
      font-weight: 950;
      padding: 9px 12px;
      border-radius: 999px;
      cursor:pointer;
      font-size: 13px;
      box-shadow:none;
      min-height: unset;
    }
    .tab:hover{color: var(--ink); border-color: var(--line)}
    .tab.active{
      color: #fff;
      background: linear-gradient(180deg, #3b82f6 0%, #2563eb 100%);
      border-color: rgba(37,99,235,.35);
    }

    /* Month Nav (★矢印の位置を整える) */
    .segNav{
      display:grid;
      grid-template-columns: 44px 1fr 44px;
      gap: 8px;
      align-items: center;
    }
    .segBtn{
      width:44px;
      height: var(--controlH);
      padding: 0;
      border-radius: 14px;
      display:grid;
      place-items:center;
      font-weight: 950;
    }

    /* Table */
    .list{
      border:1px solid var(--line);
      border-radius: 16px;
      overflow:hidden;
      background: #fff;
    }
    table{width:100%; border-collapse:collapse; font-size:14px; table-layout: fixed;}
    th, td{
      padding: 10px 10px;
      border-bottom: 1px solid #f1f5f9;
      text-align:left;
      vertical-align: top;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    th{
      background: var(--soft2);
      font-weight: 950;
      font-size: 12px;
      color: #475569;
    }
    tr:hover td{background: #fbfcff}
    .center{text-align:center}
    .small{font-size:12px}
    .right{margin-left:auto}

    .tag{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--line);
      background: #fff;
      border-radius:999px;
      padding: 5px 10px;
      font-size: 12px;
      font-weight: 950;
      color: #334155;
      max-width: 260px;
    }

    .panelHeader{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      padding: 10px 12px;
      border:1px solid var(--line);
      background: var(--soft2);
      border-radius: 16px;
    }
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding: 8px 10px;
      border:1px solid var(--line);
      background: #fff;
      border-radius: 999px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 900;
    }
    .pill b{color: var(--ink); font-weight: 950}

    .searchRow{
      display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end;
      padding: 10px 12px;
      border:1px solid var(--line);
      background: #fff;
      border-radius: 16px;
    }
    .hint{font-size:12px; color: #64748b; margin-top:8px; line-height:1.5}

    .bottom-bar{
      position: sticky;
      bottom: 0;
      z-index: 10;
      margin-top: 12px;
      padding: 10px;
      border:1px solid var(--line);
      border-radius: 16px;
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
    }

    .footer{
      padding: 12px 14px 14px;
      color: #64748b;
      font-size: 12px;
      border-top: 1px solid var(--line);
      background: #fbfbfe;
    }

    /* Modal */
    .modalOverlay{
      position: fixed; inset: 0;
      background: rgba(15,23,42,.35);
      display:none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 1000;
    }
    .modal{
      width: min(920px, 100%);
      background: #fff;
      border:1px solid var(--line);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHead{
      padding: 12px 14px;
      border-bottom:1px solid var(--line);
      background: var(--soft2);
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
    }
    .modalTitle{font-weight:950}
    .modalBody{padding: 14px}
    .modalFoot{padding: 12px 14px; border-top:1px solid var(--line); background: #fff; display:flex; gap:10px; justify-content:flex-end}

    /* ★設定テーブルは幅優先で見やすく（入力欄を広く） */
    .settingsTable{ table-layout: auto !important; }
    .settingsTable td, .settingsTable th{
      white-space: normal !important;
      overflow: visible !important;
      text-overflow: clip !important;
      vertical-align: middle;
    }
    .settingsTable input[type="text"]{
      height: var(--controlH);
      width: 100%;
      min-width: 360px; /* ★ここを広く */
    }
    @media (max-width: 980px){
      .grid{grid-template-columns: 1fr;}
      .badge{margin-left:0}
      .kpiGrid{grid-template-columns: 1fr}
      .tabs{border-radius: 18px}
      .settingsTable input[type="text"]{ min-width: 220px; }
    }
    @media (max-width: 860px){
      table, thead, tbody, th, td, tr{display:block}
      thead{display:none}
      tr{
        border-bottom: 1px solid #eef2f7;
        padding: 10px 10px 2px;
        background: #fff;
      }
      td{
        border:0;
        padding: 8px 0;
        white-space: normal;
        overflow: visible;
        text-overflow: clip;
        display:flex;
        gap:10px;
        align-items:flex-start;
      }
      td::before{
        content: attr(data-label);
        flex: 0 0 130px;
        color: #64748b;
        font-weight: 900;
        font-size: 12px;
      }
      td.center{text-align:left}
      .actions{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
      .actions .full{grid-column: 1 / -1}
      button{width:100%}
      .group{grid-template-columns: 1fr}
      .segNav{grid-template-columns: 44px 1fr 44px;}
      /* 設定入力のカード表示では幅制限を弱める */
      .settingsTable input[type="text"]{ min-width: 0; }
    }
  </style>

  <!-- Excel export (SheetJS) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>

<body>
  <main class="app" role="application">
    <header>
      <div class="topbar">
        <div style="min-width:260px; flex:1">
          <h1>休暇時間計算アプリ（職員別・月別・年度別／種別カスタム）</h1>
          <div class="subtitle">クラウド不要（localStorage）／年度は4月始まり（4〜翌3月）／Excel出力・JSONバックアップ対応</div>
        </div>
        <div class="badge"><span class="dot"></span>1日 = 7時間45分（465分）</div>
      </div>
    </header>

    <div class="wrap grid">
      <!-- 左：入力 -->
      <section class="card" id="inputPanel">
        <div class="cardHead">
          <div class="title">入力</div>
          <div class="meta">選択職員：<b id="chipStaffTop">-</b></div>
        </div>

        <div class="cardBody">
          <!-- ★ここを見やすく整理：上段（職員・種別・日付）高さ統一 -->
          <div class="row">
            <div class="field" style="min-width:240px; flex:1">
              <label>職員（選択）</label>
              <select id="staffSelect"></select>
            </div>
            <div class="field" style="min-width:240px; flex:1">
              <label>休暇種別</label>
              <select id="leaveTypeSelect"></select>
            </div>
            <div class="field" style="min-width:220px; flex:1">
              <label>日付（この月に計上）</label>
              <input type="date" id="dateInput" />
            </div>
          </div>

          <!-- ★表示中の月：矢印位置を整えて「入力の一部」に見せる -->
          <div class="row" style="margin-top:10px">
            <div class="field" style="min-width:260px; flex:1">
              <label>表示中の月</label>
              <div class="segNav">
                <button class="secondary segBtn" id="monthPrevBtn" type="button" aria-label="前の月">◀</button>
                <input type="month" id="monthInput" />
                <button class="secondary segBtn" id="monthNextBtn" type="button" aria-label="次の月">▶</button>
              </div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="field"><label>追加する時間</label></div>
          <div class="group">
            <div class="field"><label>日</label><input type="number" id="in_d" inputmode="numeric" min="0" value="0"></div>
            <div class="field"><label>時間</label><input type="number" id="in_h" inputmode="numeric" min="0" value="0"></div>
            <div class="field"><label>分</label><input type="number" id="in_m" inputmode="numeric" min="0" value="0"></div>
          </div>

          <div class="row" style="margin-top:10px; align-items:center">
            <div class="field" style="margin:0">
              <label style="margin-bottom:0">クイック入力</label>
            </div>
            <div class="miniRow right">
              <button class="miniBtn" id="preset1d" type="button">1日</button>
              <button class="miniBtn" id="preset1h" type="button">1時間</button>
              <button class="miniBtn" id="preset2h" type="button">2時間</button>
              <button class="miniBtn" id="preset3h" type="button">3時間</button>
              <button class="miniBtn" id="preset4h" type="button">4時間</button>
              <button class="miniBtn" id="preset5h" type="button">5時間</button>
              <button class="miniBtn" id="preset6h" type="button">6時間</button>
              <button class="miniBtn" id="preset7h" type="button">7時間</button>
            </div>
          </div>

          <div class="bottom-bar">
            <div class="actions">
              <button id="addBtn" class="full" type="button">追加（この職員に合算）</button>
              <button class="secondary" id="undoBtn" type="button">元に戻す</button>
              <button class="secondary" id="duplicateBtn" type="button">直前を複製</button>
              <button class="secondary" id="clearInputBtn" type="button">入力クリア</button>
              <button class="ghost" id="copyBtn" type="button">月累計をコピー</button>
              <button class="danger full" id="resetAllBtn" type="button">全データ初期化</button>
            </div>
            <div class="hint">Enterキーで追加（検索・設定入力中は除外）。「直前を複製」は同じ日付・種別・時間で1件追加します。</div>
          </div>

          <div style="margin-top:12px" class="kpiGrid">
            <div class="kpiCard">
              <div class="t">この職員の月累計（種別別）</div>
              <div id="myMonthList" class="kpiList"></div>
            </div>
            <div class="kpiCard">
              <div class="t">全職員の月累計（種別別）</div>
              <div id="allMonthList" class="kpiList"></div>
            </div>
          </div>

          <div class="chips">
            <span class="chip"><strong>月</strong> <span id="chipMonth">----</span></span>
            <span class="chip"><strong>年度</strong> <span id="chipFY">----</span></span>
            <span class="chip"><strong>保存</strong> localStorage</span>
          </div>

          <div class="noteBox">
            ・年度は <b>4月〜翌年3月</b>（例：2025年度＝2025-04〜2026-03）<br>
            ・種別は「設定」タブで追加・名称変更・削除ができます（記録は種別IDで保持）<br>
            ・横スクロール不要：小画面では表がカード表示に切り替わります
          </div>
        </div>
      </section>

      <!-- 右：一覧 -->
      <section class="card" id="rightPanel">
        <div class="cardHead" style="gap:10px">
          <div class="title">一覧</div>
          <div class="meta">月：<span id="monthLabel">----</span> ／ 年度：<span id="fyLabel">----</span></div>
        </div>

        <div class="cardBody">
          <div class="tabs" role="tablist" aria-label="表示切替">
            <button class="tab active" id="tabIndividual" data-tab="individual" type="button">個別（履歴）</button>
            <button class="tab" id="tabAll" data-tab="all" type="button">全職員（月一覧）</button>
            <button class="tab" id="tabFY" data-tab="fy" type="button">年度（一覧）</button>
            <button class="tab" id="tabSettings" data-tab="settings" type="button">設定</button>
          </div>

          <!-- 個別：履歴 -->
          <div id="panelIndividual" style="margin-top:12px">
            <div class="panelHeader">
              <div class="pill"><span>職員</span><b id="indStaffName">-</b></div>
              <div class="pill"><span>月</span><b id="indMonth">-</b></div>
              <div class="pill"><span>合計</span><b id="indMonthTotal">0日 0時間 0分</b></div>
              <div class="actions right">
                <button class="secondary" id="detailMonthBtn" type="button">内訳（分）</button>
                <button class="secondary" id="exportIndividualBtn" type="button">個別CSV</button>
                <button class="secondary" id="exportIndividualXlsxBtn" type="button">個別Excel</button>
              </div>
            </div>

            <div class="searchRow" style="margin-top:10px">
              <div class="field" style="flex:1; min-width:240px">
                <label>履歴検索（この月）</label>
                <input type="text" id="histQuery" placeholder="例）2026-01-15 / 年次 / 30分 など" />
              </div>
              <div class="field" style="min-width:220px">
                <label>種別で絞り込み</label>
                <select id="histTypeFilter"></select>
              </div>
              <div class="actions right">
                <button class="secondary" id="histClearBtn" type="button">検索クリア</button>
                <button class="danger" id="bulkDeleteMonthBtn" type="button">この月を一括削除</button>
              </div>
            </div>

            <div class="list" style="margin-top:10px">
              <table>
                <thead>
                  <tr>
                    <th style="width:52px" class="center">#</th>
                    <th style="width:120px" class="nowrap">日付</th>
                    <th style="width:220px" class="nowrap">種別</th>
                    <th>追加</th>
                    <th style="width:90px" class="nowrap">分</th>
                    <th style="width:120px" class="center">操作</th>
                  </tr>
                </thead>
                <tbody id="histBody"></tbody>
              </table>
            </div>
            <div class="hint">「削除」は該当記録のみ削除し、累計は自動再計算されます。</div>
          </div>

          <!-- 全職員：月一覧 -->
          <div id="panelAll" style="margin-top:12px; display:none">
            <div class="panelHeader">
              <div class="pill"><span>月</span><b id="allMonth">-</b></div>
              <div class="pill"><span>全職員合計</span><b id="allMonthTotal">0日 0時間 0分</b></div>
              <div class="actions right">
                <button class="secondary" id="detailAllMonthBtn" type="button">内訳（分）</button>
                <button class="secondary" id="exportAllBtn" type="button">全職員CSV</button>
                <button class="secondary" id="exportAllXlsxBtn" type="button">全職員Excel</button>
              </div>
            </div>

            <div class="noteBox" style="margin-top:10px">
              一覧表示は「設定 ＞ 一覧に表示する種別（最大4）」で列数を調整できます（横スクロール防止）。
            </div>

            <div class="list" style="margin-top:10px">
              <table>
                <thead id="allThead"></thead>
                <tbody id="allBody"></tbody>
              </table>
            </div>
          </div>

          <!-- 年度：一覧 -->
          <div id="panelFY" style="margin-top:12px; display:none">
            <div class="panelHeader">
              <div class="pill"><span>年度</span><b id="fyPanelFY">-</b></div>
              <div class="pill"><span>全職員合計</span><b id="allFYTotal">0日 0時間 0分</b></div>

              <!-- ★年度操作を右側に配置（入力欄から移動） -->
              <div class="row right" style="gap:8px; align-items:center">
                <button class="secondary segBtn" id="fyPrevBtn" type="button" aria-label="前年度">◀</button>
                <input type="number" id="fyInput" min="2000" max="2100" step="1" style="width:120px" />
                <button class="secondary segBtn" id="fyNextBtn" type="button" aria-label="次年度">▶</button>
              </div>

              <div class="actions" style="width:100%">
                <button class="secondary" id="detailFYBtn" type="button">内訳（分）</button>
                <button class="secondary" id="exportFYXlsxBtn" type="button">年度Excel</button>
              </div>
            </div>

            <div class="divider"></div>

            <div class="small" style="color:var(--muted); font-weight:950">全職員：年度合計（種別別）</div>
            <div class="list" style="margin-top:8px">
              <table>
                <thead id="fyAllThead"></thead>
                <tbody id="fyAllBody"></tbody>
              </table>
            </div>

            <div class="divider"></div>

            <div class="row" style="align-items:center">
              <div class="small" style="color:var(--muted); font-weight:950">選択職員：月別内訳（種別別）※4月始まり</div>
              <div class="pill right"><span>職員</span><b id="fyStaffName">-</b></div>
            </div>

            <div class="list" style="margin-top:8px">
              <table>
                <thead id="fyStaffThead"></thead>
                <tbody id="fyStaffBody"></tbody>
              </table>
            </div>

            <div class="divider"></div>

            <div class="small" style="color:var(--muted); font-weight:950">選択職員：年度内履歴（検索）</div>
            <div class="searchRow" style="margin-top:8px">
              <div class="field" style="flex:1; min-width:240px">
                <label>履歴検索（年度内）</label>
                <input type="text" id="fyHistQuery" placeholder="例）2026-02 / 年次 / 465 / 1日 など" />
              </div>
              <div class="field" style="min-width:220px">
                <label>種別で絞り込み</label>
                <select id="fyHistTypeFilter"></select>
              </div>
              <div class="actions right">
                <button class="secondary" id="fyHistClearBtn" type="button">検索クリア</button>
              </div>
            </div>

            <div class="list" style="margin-top:10px">
              <table>
                <thead>
                  <tr>
                    <th style="width:52px" class="center">#</th>
                    <th style="width:120px" class="nowrap">日付</th>
                    <th style="width:90px" class="nowrap">月</th>
                    <th style="width:220px" class="nowrap">種別</th>
                    <th>追加</th>
                    <th style="width:90px" class="nowrap">分</th>
                  </tr>
                </thead>
                <tbody id="fyHistBody"></tbody>
              </table>
            </div>

            <div class="hint">
              年度は <b>4月〜翌3月</b> を集計します。年度Excelは3シート（全職員年度合計／選択職員月別内訳／選択職員年度内履歴）。
            </div>
          </div>

          <!-- 設定 -->
          <div id="panelSettings" style="margin-top:12px; display:none">
            <div class="panelHeader">
              <div class="pill"><b>設定</b></div>
              <div class="pill"><span>職員</span><b id="staffCount">0</b></div>
              <div class="pill"><span>種別</span><b id="typeCount">0</b></div>
              <div class="pill"><span>一覧列</span><b id="visibleCount">0</b></div>

              <!-- ★年度（4月始まり）を設定側に配置 -->
              <div class="row right" style="gap:8px; align-items:center">
                <span class="pill"><span>表示年度</span><b id="settingsFYLabel">-</b></span>
              </div>
            </div>

            <div class="divider"></div>

            <div class="row" style="align-items:flex-start">
              <div style="flex:1; min-width:320px">
                <div class="small" style="color:var(--muted); font-weight:950; margin-bottom:8px">職員の登録（最大50）</div>
                <div class="searchRow">
                  <div class="field" style="flex:1; min-width:260px">
                    <label>追加する職員名</label>
                    <input type="text" id="newStaffName" placeholder="例）山田 太郎" maxlength="30" />
                  </div>
                  <button class="ok" id="addStaffBtn" type="button" style="min-width:160px">職員を登録</button>
                </div>

                <div class="list" style="margin-top:10px">
                  <table class="settingsTable">
                    <thead>
                      <tr>
                        <th style="width:52px" class="center">#</th>
                        <th>職員名（名称変更可）</th>
                        <th style="width:220px" class="center nowrap">操作</th>
                      </tr>
                    </thead>
                    <tbody id="staffBody"></tbody>
                  </table>
                </div>
                <div class="hint">最低1人は必要。削除するとその職員の記録も削除されます。</div>
              </div>

              <div style="flex:1; min-width:320px">
                <div class="small" style="color:var(--muted); font-weight:950; margin-bottom:8px">休暇種別の管理（後から追加できます）</div>
                <div class="searchRow">
                  <div class="field" style="flex:1; min-width:260px">
                    <label>追加する種別名</label>
                    <input type="text" id="newTypeName" placeholder="例）介護休暇 / 病気休暇 など" maxlength="40" />
                  </div>
                  <button class="ok" id="addTypeBtn" type="button" style="min-width:160px">種別を追加</button>
                </div>

                <div class="list" style="margin-top:10px">
                  <table class="settingsTable">
                    <thead>
                      <tr>
                        <th style="width:52px" class="center">#</th>
                        <th>種別名（名称変更可）</th>
                        <th style="width:220px" class="center nowrap">操作</th>
                      </tr>
                    </thead>
                    <tbody id="typeBody"></tbody>
                  </table>
                </div>
                <div class="hint">初期で「年次休暇」「特別休暇」。削除すると該当記録は「不明」扱い（データ自体は残ります）。</div>
              </div>
            </div>

            <div class="divider"></div>

            <div class="row" style="align-items:flex-start">
              <div style="flex:1; min-width:320px">
                <div class="small" style="color:var(--muted); font-weight:950; margin-bottom:8px">一覧に表示する種別（最大4）</div>
                <div class="noteBox">
                  月一覧／年度一覧の列数を抑えて横スクロールを防ぎます。<br>
                  ここで外した種別も <b>内訳（分）</b> と <b>Excel/CSV</b> には反映されます。
                </div>
                <div class="list" style="margin-top:10px">
                  <table class="settingsTable">
                    <thead>
                      <tr>
                        <th style="width:52px" class="center">#</th>
                        <th>種別</th>
                        <th style="width:160px" class="center nowrap">一覧に表示</th>
                      </tr>
                    </thead>
                    <tbody id="visibleTypeBody"></tbody>
                  </table>
                </div>
              </div>

              <div style="flex:1; min-width:320px">
                <div class="small" style="color:var(--muted); font-weight:950; margin-bottom:8px">バックアップ／復元（JSON）</div>
                <div class="searchRow">
                  <button class="secondary" id="exportJsonBtn" type="button" style="min-width:200px">JSONバックアップ</button>
                  <label class="secondary" style="display:inline-flex; align-items:center; gap:10px; padding:11px 14px; border-radius:14px; border:1px solid var(--line); cursor:pointer;">
                    JSON復元
                    <input type="file" id="importJsonInput" accept="application/json" style="display:none">
                  </label>
                  <button class="danger" id="wipeOnlyEntriesBtn" type="button" style="min-width:220px">履歴だけ全消去</button>
                </div>
                <div class="hint">
                  ・JSON復元は <b>端末内のデータを置き換え</b> ます（確認あり）<br>
                  ・クラウド不要のため、年度末などにバックアップ推奨
                </div>
              </div>
            </div>

            <div class="noteBox">
              <b>追加した便利機能</b><br>
              ・「直前を複製」／「この月を一括削除」／月・年度の移動／一覧列のカスタム／JSONバックアップ
            </div>
          </div>

        </div>
      </section>
    </div>

    <div class="footer">© 休暇時間計算アプリ（事務向け） Takayuki WAYAMA</div>
  </main>

  <!-- Details Modal -->
  <div class="modalOverlay" id="modalOverlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <div class="modalHead">
        <div class="modalTitle" id="modalTitle">内訳</div>
        <div class="pill right"><span>合計</span><b id="modalTotal">0日 0時間 0分</b></div>
      </div>
      <div class="modalBody">
        <div class="list">
          <table>
            <thead>
              <tr>
                <th style="width:52px" class="center">#</th>
                <th>種別</th>
                <th style="width:140px" class="nowrap">表示</th>
                <th style="width:120px" class="nowrap">分</th>
              </tr>
            </thead>
            <tbody id="modalBody"></tbody>
          </table>
        </div>
        <div class="hint" id="modalHint"></div>
      </div>
      <div class="modalFoot">
        <button class="secondary" id="modalCopyBtn" type="button">コピー</button>
        <button id="modalCloseBtn" type="button">閉じる</button>
      </div>
    </div>
  </div>

  <script>
    // =========================
    // 設定
    // =========================
    const DAY_MIN = 465;

    // 旧 v1 互換読み込み用
    const KEY_V1 = 'worktime_accum_v1';

    // メイン
    const KEY_MAIN = 'worktime_accum_staff_v3_white';
    const VERSION = 5;

    const $ = (id)=>document.getElementById(id);
    const toInt = (v)=>{ const n=parseInt(v,10); return isNaN(n)?0:Math.max(0,n); };
    const totalMinutes = (d,h,m)=> toInt(d)*DAY_MIN + toInt(h)*60 + toInt(m);
    const normalize = (t)=>{
      const d = Math.floor(t / DAY_MIN);
      const rem = t - d*DAY_MIN;
      const h = Math.floor(rem/60);
      const m = rem - h*60;
      return {d,h,m};
    };
    const fmt = (d,h,m)=> `${d}日 ${h}時間 ${m}分`;
    const fmtMin = (t)=>{
      const n = normalize(t);
      return fmt(n.d,n.h,n.m);
    };

    const todayStr = ()=>{
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    };
    const monthFromDate = (dateStr)=>{
      if(!dateStr || dateStr.length<7) return '';
      return dateStr.slice(0,7);
    };
    const yearFromDate = (dateStr)=>{
      if(!dateStr || dateStr.length<4) return '';
      return dateStr.slice(0,4);
    };
    const monthNowStr = ()=> monthFromDate(todayStr());
    const yearNowStr = ()=> yearFromDate(todayStr());

    const uuid = ()=> (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()+Math.random()));
    const shortId = ()=> uuid().replace(/-/g,'').slice(0,10);

    function escapeHtml(s){
      return String(s ?? '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    // ★重要：月キーを必ず YYYY-MM に統一
    function normalizeMonthKey(m){
      if(!m) return '';
      const s = String(m).trim();
      const m1 = s.match(/^(\d{4})-(\d{1,2})$/);
      if(m1){
        const y = m1[1];
        const mm = String(Number(m1[2])).padStart(2,'0');
        return `${y}-${mm}`;
      }
      const m2 = s.match(/^(\d{4})-(\d{2})/);
      if(m2) return `${m2[1]}-${m2[2]}`;
      return s;
    }

    function defaultTypes(){
      return [
        {id:'annual', name:'年次休暇'},
        {id:'special', name:'特別休暇'}
      ];
    }
    function defaultVisibleTypes(){
      return ['annual','special'];
    }

    function loadState(){
      try{
        const raw = localStorage.getItem(KEY_MAIN);
        if(raw){
          const obj = JSON.parse(raw);
          if(obj && (obj.version>=3) && Array.isArray(obj.staff) && Array.isArray(obj.entries)){
            if(!Array.isArray(obj.leaveTypes) || obj.leaveTypes.length===0) obj.leaveTypes = defaultTypes();
            if(!obj.leaveTypes.some(t=>t.id==='annual')) obj.leaveTypes.unshift({id:'annual', name:'年次休暇'});
            if(!obj.leaveTypes.some(t=>t.id==='special')) obj.leaveTypes.push({id:'special', name:'特別休暇'});

            obj.entries = obj.entries.map(e=>({
              ...e,
              month: normalizeMonthKey(e.month || (e.date ? monthFromDate(e.date) : monthNowStr())),
              leaveTypeId: e.leaveTypeId || 'annual'
            }));

            if(obj.staff.length===0) obj.staff = [{id: uuid(), name:'（未設定）'}];
            if(!obj.currentStaffId || !obj.staff.some(s=>s.id===obj.currentStaffId)) obj.currentStaffId = obj.staff[0].id;

            if(!obj.currentTab) obj.currentTab = 'individual';
            if(!obj.currentMonth) obj.currentMonth = monthNowStr();
            obj.currentMonth = normalizeMonthKey(obj.currentMonth);
            if(!obj.currentFY) obj.currentFY = Number(yearNowStr());
            if(!obj.currentLeaveTypeId) obj.currentLeaveTypeId = 'annual';

            if(obj.histQuery==null) obj.histQuery = '';
            if(obj.histTypeFilter==null) obj.histTypeFilter = 'all';
            if(obj.fyHistQuery==null) obj.fyHistQuery = '';
            if(obj.fyHistTypeFilter==null) obj.fyHistTypeFilter = 'all';

            if(!Array.isArray(obj.visibleTypeIds)) obj.visibleTypeIds = defaultVisibleTypes();
            obj.visibleTypeIds = obj.visibleTypeIds.filter(id=> obj.leaveTypes.some(t=>t.id===id));
            if(obj.visibleTypeIds.length===0) obj.visibleTypeIds = defaultVisibleTypes().filter(id=> obj.leaveTypes.some(t=>t.id===id));

            obj.version = VERSION;
            saveState(obj);
            return obj;
          }
        }
      }catch(e){}

      // migrate v1
      try{
        const raw1 = localStorage.getItem(KEY_V1);
        if(raw1){
          const v1 = JSON.parse(raw1);
          if(v1 && typeof v1.sum==='number' && Array.isArray(v1.items)){
            const staffId = uuid();
            const date = todayStr();
            const month = normalizeMonthKey(monthFromDate(date));
            const fy = Number(yearFromDate(date));
            const entries = v1.items.map((it, idx)=>({
              id: it.id || uuid(),
              staffId,
              date,
              month,
              leaveTypeId: 'annual',
              d: toInt(it.d),
              h: toInt(it.h),
              m: toInt(it.m),
              delta: toInt(it.delta),
              createdAt: Date.now() + idx
            }));
            const migrated = {
              version: VERSION,
              staff: [{id: staffId, name: '（旧データ）'}],
              leaveTypes: defaultTypes(),
              entries,
              visibleTypeIds: defaultVisibleTypes(),
              currentStaffId: staffId,
              currentMonth: monthNowStr(),
              currentFY: fy,
              currentLeaveTypeId: 'annual',
              currentTab: 'individual',
              histQuery: '',
              histTypeFilter: 'all',
              fyHistQuery: '',
              fyHistTypeFilter: 'all'
            };
            saveState(migrated);
            return migrated;
          }
        }
      }catch(e){}

      // new
      const def = {id: uuid(), name:'（未設定）'};
      const init = {
        version: VERSION,
        staff: [def],
        leaveTypes: defaultTypes(),
        entries: [],
        visibleTypeIds: defaultVisibleTypes(),
        currentStaffId: def.id,
        currentMonth: monthNowStr(),
        currentFY: Number(yearNowStr()),
        currentLeaveTypeId: 'annual',
        currentTab: 'individual',
        histQuery: '',
        histTypeFilter: 'all',
        fyHistQuery: '',
        fyHistTypeFilter: 'all'
      };
      saveState(init);
      return init;
    }

    function saveState(state){
      localStorage.setItem(KEY_MAIN, JSON.stringify(state));
    }

    // =========================
    // 種別ヘルパ
    // =========================
    function getType(st, id){
      return st.leaveTypes.find(t=>t.id===id) || {id, name:'（不明）'};
    }
    function typeColor(id){
      if(id==='annual') return '#2563eb';
      if(id==='special') return '#10b981';
      let h = 0;
      for(const c of String(id)) h = (h*31 + c.charCodeAt(0)) >>> 0;
      const hue = h % 360;
      return `hsl(${hue} 65% 45%)`;
    }
    function typeBadgeHtml(st, id){
      const t = getType(st, id);
      const color = typeColor(id);
      return `<span class="tag" title="${escapeHtml(t.name)}"><span class="dot2" style="background:${color}"></span>${escapeHtml(t.name)}</span>`;
    }

    // =========================
    // 集計
    // =========================
    function entriesForMonth(st, staffId, month){
      const mk = normalizeMonthKey(month);
      return st.entries
        .filter(e=> e.staffId===staffId && normalizeMonthKey(e.month)===mk)
        .sort((a,b)=> (b.createdAt||0) - (a.createdAt||0));
    }
    function totalForMonthType(st, staffId, month, typeId){
      const mk = normalizeMonthKey(month);
      return st.entries
        .filter(e=> e.staffId===staffId && normalizeMonthKey(e.month)===mk && (e.leaveTypeId||'annual')===typeId)
        .reduce((acc,e)=> acc + toInt(e.delta), 0);
    }
    function totalForMonthAllTypes(st, staffId, month){
      const mk = normalizeMonthKey(month);
      return st.entries
        .filter(e=> e.staffId===staffId && normalizeMonthKey(e.month)===mk)
        .reduce((acc,e)=> acc + toInt(e.delta), 0);
    }
    function totalAllStaffMonthType(st, month, typeId){
      return st.staff.reduce((acc,s)=> acc + totalForMonthType(st, s.id, month, typeId), 0);
    }
    function totalAllStaffMonthAllTypes(st, month){
      return st.staff.reduce((acc,s)=> acc + totalForMonthAllTypes(st, s.id, month), 0);
    }

    // 年度（FY: 4月〜翌3月）
    function fyMonthKeys(fy){
      const y = Number(fy);
      const months = [];
      for(let m=4;m<=12;m++) months.push(`${y}-${String(m).padStart(2,'0')}`);
      for(let m=1;m<=3;m++) months.push(`${y+1}-${String(m).padStart(2,'0')}`);
      return months.map(normalizeMonthKey);
    }
    function entriesForFY(st, staffId, fy){
      const keys = new Set(fyMonthKeys(fy));
      return st.entries
        .filter(e=> e.staffId===staffId && keys.has(normalizeMonthKey(e.month)))
        .sort((a,b)=> (b.createdAt||0) - (a.createdAt||0));
    }
    function totalForFYType(st, staffId, fy, typeId){
      const keys = new Set(fyMonthKeys(fy));
      return st.entries
        .filter(e=> e.staffId===staffId && keys.has(normalizeMonthKey(e.month)) && (e.leaveTypeId||'annual')===typeId)
        .reduce((acc,e)=> acc + toInt(e.delta), 0);
    }
    function totalForFYAllTypes(st, staffId, fy){
      const keys = new Set(fyMonthKeys(fy));
      return st.entries
        .filter(e=> e.staffId===staffId && keys.has(normalizeMonthKey(e.month)))
        .reduce((acc,e)=> acc + toInt(e.delta), 0);
    }
    function totalAllStaffFYAllTypes(st, fy){
      return st.staff.reduce((acc,s)=> acc + totalForFYAllTypes(st, s.id, fy), 0);
    }

    // =========================
    // タブ
    // =========================
    function setTab(tab, persist=true){
      const st = loadState();
      const t = ['individual','all','fy','settings'].includes(tab) ? tab : 'individual';

      $('tabIndividual').classList.toggle('active', t==='individual');
      $('tabAll').classList.toggle('active', t==='all');
      $('tabFY').classList.toggle('active', t==='fy');
      $('tabSettings').classList.toggle('active', t==='settings');

      $('panelIndividual').style.display = (t==='individual') ? '' : 'none';
      $('panelAll').style.display = (t==='all') ? '' : 'none';
      $('panelFY').style.display = (t==='fy') ? '' : 'none';
      $('panelSettings').style.display = (t==='settings') ? '' : 'none';

      // ★設定タブ時：左の入力欄を隠す
      document.body.classList.toggle('settingsMode', t==='settings');

      if(persist){
        st.currentTab = t;
        saveState(st);
      }
    }

    // =========================
    // 描画（小画面カード用 data-label 付与）
    // =========================
    function setCellLabels(tbody, labels){
      Array.from(tbody.querySelectorAll('tr')).forEach(tr=>{
        const tds = Array.from(tr.children);
        tds.forEach((td,i)=>{
          const lb = labels[i];
          if(lb) td.setAttribute('data-label', lb);
        });
      });
    }

    function fillTypeFilterSelect(selectId, st, selected){
      const sel = $(selectId);
      sel.innerHTML = '';
      const optAll = document.createElement('option');
      optAll.value = 'all';
      optAll.textContent = 'すべて';
      sel.appendChild(optAll);
      st.leaveTypes.forEach(t=>{
        const o = document.createElement('option');
        o.value = t.id;
        o.textContent = t.name;
        sel.appendChild(o);
      });
      sel.value = selected && (selected==='all' || st.leaveTypes.some(t=>t.id===selected)) ? selected : 'all';
    }

    function renderKpiLists(st, staffId, month){
      const myWrap = $('myMonthList');
      const allWrap = $('allMonthList');
      myWrap.innerHTML = '';
      allWrap.innerHTML = '';

      st.leaveTypes.forEach(t=>{
        const v = totalForMonthType(st, staffId, month, t.id);
        const item = document.createElement('div');
        item.className = 'kpiItem';
        item.innerHTML = `
          <div class="left">
            <span class="dot2" style="background:${typeColor(t.id)}"></span>
            <div class="name">${escapeHtml(t.name)}</div>
          </div>
          <b>${fmtMin(v)}</b>
        `;
        myWrap.appendChild(item);
      });

      st.leaveTypes.forEach(t=>{
        const v = totalAllStaffMonthType(st, month, t.id);
        const item = document.createElement('div');
        item.className = 'kpiItem';
        item.innerHTML = `
          <div class="left">
            <span class="dot2" style="background:${typeColor(t.id)}"></span>
            <div class="name">${escapeHtml(t.name)}</div>
          </div>
          <b>${fmtMin(v)}</b>
        `;
        allWrap.appendChild(item);
      });
    }

    function renderIndividualHistory(st, staffId, month){
      const tbody = $('histBody');
      tbody.innerHTML = '';

      const q = (st.histQuery || '').trim().toLowerCase();
      const typeFilter = st.histTypeFilter || 'all';

      const list = entriesForMonth(st, staffId, month).filter(e=>{
        const typeId = e.leaveTypeId || 'annual';
        const typeName = getType(st, typeId).name.toLowerCase();
        const base = [
          e.date || '',
          e.month || '',
          typeName,
          String(e.delta||''),
          `${e.d||0}日${e.h||0}時間${e.m||0}分`,
          `${e.d||0} ${e.h||0} ${e.m||0}`
        ].join(' ').toLowerCase();

        const okType = (typeFilter==='all') ? true : (typeId===typeFilter);
        const okQ = q ? base.includes(q) : true;
        return okType && okQ;
      });

      list.forEach((e, i)=>{
        const typeId = e.leaveTypeId || 'annual';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="center">${i+1}</td>
          <td class="nowrap">${escapeHtml(e.date||'')}</td>
          <td class="nowrap">${typeBadgeHtml(st, typeId)}</td>
          <td>${fmt(toInt(e.d),toInt(e.h),toInt(e.m))}</td>
          <td class="nowrap">${toInt(e.delta)}</td>
          <td class="center">
            <button class="secondary" data-act="delete" data-id="${e.id}" type="button">削除</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      setCellLabels(tbody, ['#','日付','種別','追加','分','操作']);
    }

    function visibleCols(st){
      const ids = (st.visibleTypeIds || []).filter(id=> st.leaveTypes.some(t=>t.id===id)).slice(0,4);
      if(ids.length===0){
        return st.leaveTypes.slice(0, Math.min(4, st.leaveTypes.length)).map(t=>t.id);
      }
      return ids;
    }

    function renderAllMonthTable(st, month){
      const thead = $('allThead');
      const colIds = visibleCols(st);
      const cols = colIds.map(id=> getType(st,id));

      thead.innerHTML = `
        <tr>
          <th style="width:52px" class="center">#</th>
          <th>職員名</th>
          ${cols.map(t=> `<th class="nowrap" style="width:150px">${escapeHtml(t.name)}</th>`).join('')}
          <th class="nowrap" style="width:160px">合計</th>
          <th class="nowrap" style="width:120px" class="center">詳細</th>
        </tr>
      `;

      const body = $('allBody');
      body.innerHTML = '';
      st.staff.forEach((s, idx)=>{
        const parts = colIds.map(id=> totalForMonthType(st, s.id, month, id));
        const sum = totalForMonthAllTypes(st, s.id, month);

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="center">${idx+1}</td>
          <td style="font-weight:950">${escapeHtml(s.name)}</td>
          ${parts.map(v=> `<td class="nowrap">${fmtMin(v)}</td>`).join('')}
          <td class="nowrap" style="font-weight:950">${fmtMin(sum)}</td>
          <td class="center">
            <button class="secondary" data-act="detailStaffMonth" data-id="${s.id}" type="button">内訳</button>
          </td>
        `;
        body.appendChild(tr);
      });

      setCellLabels(body, ['#','職員名', ...cols.map(t=>t.name), '合計','詳細']);
    }

    function renderAllFYTable(st, fy){
      const thead = $('fyAllThead');
      const colIds = visibleCols(st);
      const cols = colIds.map(id=> getType(st,id));

      thead.innerHTML = `
        <tr>
          <th style="width:52px" class="center">#</th>
          <th>職員名</th>
          ${cols.map(t=> `<th class="nowrap" style="width:150px">${escapeHtml(t.name)}</th>`).join('')}
          <th class="nowrap" style="width:160px">合計</th>
          <th class="nowrap" style="width:120px" class="center">詳細</th>
        </tr>
      `;

      const body = $('fyAllBody');
      body.innerHTML = '';
      st.staff.forEach((s, idx)=>{
        const parts = colIds.map(id=> totalForFYType(st, s.id, fy, id));
        const sum = totalForFYAllTypes(st, s.id, fy);

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="center">${idx+1}</td>
          <td style="font-weight:950">${escapeHtml(s.name)}</td>
          ${parts.map(v=> `<td class="nowrap">${fmtMin(v)}</td>`).join('')}
          <td class="nowrap" style="font-weight:950">${fmtMin(sum)}</td>
          <td class="center">
            <button class="secondary" data-act="detailStaffFY" data-id="${s.id}" type="button">内訳</button>
          </td>
        `;
        body.appendChild(tr);
      });

      setCellLabels(body, ['#','職員名', ...cols.map(t=>t.name), '合計','詳細']);
    }

    function renderFYStaffMonthlyBreakdown(st, staffId, fy){
      const thead = $('fyStaffThead');
      const colIds = visibleCols(st);
      const cols = colIds.map(id=> getType(st,id));

      thead.innerHTML = `
        <tr>
          <th class="center nowrap" style="width:90px">月</th>
          ${cols.map(t=> `<th class="nowrap" style="width:150px">${escapeHtml(t.name)}</th>`).join('')}
          <th class="nowrap" style="width:160px">合計</th>
          <th class="nowrap" style="width:120px" class="center">詳細</th>
        </tr>
      `;

      const body = $('fyStaffBody');
      body.innerHTML = '';
      const months = fyMonthKeys(fy);

      months.forEach(mkey=>{
        const parts = colIds.map(id=> totalForMonthType(st, staffId, mkey, id));
        const sum = totalForMonthAllTypes(st, staffId, mkey);

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="center nowrap" style="font-weight:950">${escapeHtml(mkey)}</td>
          ${parts.map(v=> `<td class="nowrap">${fmtMin(v)}</td>`).join('')}
          <td class="nowrap" style="font-weight:950">${fmtMin(sum)}</td>
          <td class="center">
            <button class="secondary" data-act="detailStaffMonth" data-id="${staffId}" data-month="${mkey}" type="button">内訳</button>
          </td>
        `;
        body.appendChild(tr);
      });

      setCellLabels(body, ['月', ...cols.map(t=>t.name), '合計', '詳細']);
    }

    function renderFYHistory(st, staffId, fy){
      const tbody = $('fyHistBody');
      tbody.innerHTML = '';

      const q = (st.fyHistQuery || '').trim().toLowerCase();
      const typeFilter = st.fyHistTypeFilter || 'all';

      const list = entriesForFY(st, staffId, fy).filter(e=>{
        const typeId = e.leaveTypeId || 'annual';
        const typeName = getType(st, typeId).name.toLowerCase();
        const base = [
          e.date || '',
          e.month || '',
          typeName,
          String(e.delta||''),
          `${e.d||0}日${e.h||0}時間${e.m||0}分`
        ].join(' ').toLowerCase();

        const okType = (typeFilter==='all') ? true : (typeId===typeFilter);
        const okQ = q ? base.includes(q) : true;
        return okType && okQ;
      });

      list.forEach((e, i)=>{
        const typeId = e.leaveTypeId || 'annual';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="center">${i+1}</td>
          <td class="nowrap">${escapeHtml(e.date||'')}</td>
          <td class="nowrap">${escapeHtml(normalizeMonthKey(e.month)||'')}</td>
          <td class="nowrap">${typeBadgeHtml(st, typeId)}</td>
          <td>${fmt(toInt(e.d),toInt(e.h),toInt(e.m))}</td>
          <td class="nowrap">${toInt(e.delta)}</td>
        `;
        tbody.appendChild(tr);
      });

      setCellLabels(tbody, ['#','日付','月','種別','追加','分']);
    }

    function renderSettingsStaff(st){
      const tbody = $('staffBody');
      tbody.innerHTML = '';
      st.staff.forEach((s, idx)=>{
        const delDisabled = (st.staff.length<=1);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="center">${idx+1}</td>
          <td>
            <input type="text" value="${escapeHtml(s.name)}" data-staff-name="${s.id}" />
            <div class="small" style="color:#94a3b8; margin-top:6px">ID: ${escapeHtml(String(s.id).slice(0,8))}...</div>
          </td>
          <td class="center nowrap">
            <button class="secondary" data-act="savestaff" data-id="${s.id}" type="button">保存</button>
            <button class="danger" data-act="delstaff" data-id="${s.id}" type="button" ${delDisabled?'disabled':''}>削除</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      setCellLabels(tbody, ['#','職員名','操作']);
    }

    function renderSettingsTypes(st){
      const tbody = $('typeBody');
      tbody.innerHTML = '';
      st.leaveTypes.forEach((t, idx)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="center">${idx+1}</td>
          <td>
            <div style="display:flex; gap:10px; align-items:center">
              <span class="dot2" style="background:${typeColor(t.id)}"></span>
              <input type="text" value="${escapeHtml(t.name)}" data-type-name="${t.id}" />
            </div>
            <div class="small" style="color:#94a3b8; margin-top:6px">ID: ${escapeHtml(t.id)}</div>
          </td>
          <td class="center nowrap">
            <button class="secondary" data-act="savetype" data-id="${t.id}" type="button">保存</button>
            <button class="danger" data-act="deltype" data-id="${t.id}" type="button">削除</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      setCellLabels(tbody, ['#','種別','操作']);
    }

    function renderVisibleTypeSettings(st){
      const tbody = $('visibleTypeBody');
      tbody.innerHTML = '';
      const selected = new Set(visibleCols(st));
      st.leaveTypes.forEach((t, idx)=>{
        const checked = selected.has(t.id);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="center">${idx+1}</td>
          <td>${typeBadgeHtml(st, t.id)}</td>
          <td class="center nowrap">
            <input type="checkbox" data-act="toggleVisibleType" data-id="${t.id}" ${checked?'checked':''} />
          </td>
        `;
        tbody.appendChild(tr);
      });
      setCellLabels(tbody, ['#','種別','一覧に表示']);
    }

    function render(){
      const st = loadState();

      if(!$('dateInput').value) $('dateInput').value = todayStr();
      if(!$('monthInput').value) $('monthInput').value = st.currentMonth || monthNowStr();
      if(!$('fyInput').value) $('fyInput').value = st.currentFY || Number(yearNowStr());

      if($('histQuery').value !== st.histQuery) $('histQuery').value = st.histQuery || '';
      if($('fyHistQuery').value !== st.fyHistQuery) $('fyHistQuery').value = st.fyHistQuery || '';

      const month = normalizeMonthKey($('monthInput').value || monthNowStr());
      $('monthInput').value = month;

      const fy = Number($('fyInput').value || yearNowStr());
      st.currentMonth = month;
      st.currentFY = fy;
      saveState(st);

      $('monthLabel').textContent = month;
      $('fyLabel').textContent = `${fy}年度`;
      $('settingsFYLabel').textContent = `${fy}年度`;

      // staff select
      $('staffSelect').innerHTML = '';
      st.staff.forEach(s=>{
        const opt = document.createElement('option');
        opt.value = s.id;
        opt.textContent = s.name;
        if(s.id===st.currentStaffId) opt.selected = true;
        $('staffSelect').appendChild(opt);
      });
      const staff = st.staff.find(x=>x.id===st.currentStaffId) || st.staff[0];
      const staffId = staff.id;
      $('chipStaffTop').textContent = staff.name;

      // leave types
      $('leaveTypeSelect').innerHTML = '';
      st.leaveTypes.forEach(t=>{
        const opt = document.createElement('option');
        opt.value = t.id;
        opt.textContent = t.name;
        $('leaveTypeSelect').appendChild(opt);
      });
      if(!st.leaveTypes.some(t=>t.id===st.currentLeaveTypeId)){
        st.currentLeaveTypeId = st.leaveTypes[0]?.id || 'annual';
        saveState(st);
      }
      $('leaveTypeSelect').value = st.currentLeaveTypeId;

      // filters
      fillTypeFilterSelect('histTypeFilter', st, st.histTypeFilter);
      fillTypeFilterSelect('fyHistTypeFilter', st, st.fyHistTypeFilter);

      // chips
      $('chipMonth').textContent = month;
      $('chipFY').textContent = `${fy}年度`;

      // KPIs
      renderKpiLists(st, staffId, month);

      // Individual panel
      $('indStaffName').textContent = staff.name;
      $('indMonth').textContent = month;
      $('indMonthTotal').textContent = fmtMin(totalForMonthAllTypes(st, staffId, month));
      renderIndividualHistory(st, staffId, month);

      // All month panel
      $('allMonth').textContent = month;
      $('allMonthTotal').textContent = fmtMin(totalAllStaffMonthAllTypes(st, month));
      renderAllMonthTable(st, month);

      // FY panel
      $('fyPanelFY').textContent = `${fy}年度`;
      $('fyStaffName').textContent = staff.name;
      $('allFYTotal').textContent = fmtMin(totalAllStaffFYAllTypes(st, fy));
      renderAllFYTable(st, fy);
      renderFYStaffMonthlyBreakdown(st, staffId, fy);
      renderFYHistory(st, staffId, fy);

      // Settings panel
      $('staffCount').textContent = `${st.staff.length} / 50`;
      $('typeCount').textContent = `${st.leaveTypes.length}`;
      $('visibleCount').textContent = `${visibleCols(st).length} / 4`;
      renderSettingsStaff(st);
      renderSettingsTypes(st);
      renderVisibleTypeSettings(st);

      $('undoBtn').disabled = !st.entries.some(e=>e.staffId===staffId);
      $('duplicateBtn').disabled = !st.entries.some(e=>e.staffId===staffId);

      setTab(st.currentTab || 'individual', false);
    }

    // =========================
    // 入力操作
    // =========================
    function addEntry(){
      const st = loadState();
      const staffId = $('staffSelect').value;

      const date = $('dateInput').value || todayStr();
      const month = normalizeMonthKey(monthFromDate(date) || ($('monthInput').value || monthNowStr()));
      const leaveTypeId = $('leaveTypeSelect').value || 'annual';

      const d = toInt($('in_d').value);
      const h = toInt($('in_h').value);
      const m = toInt($('in_m').value);
      const delta = totalMinutes(d,h,m);

      if(delta===0){ alert('0は追加されません'); return; }

      st.currentStaffId = staffId;
      st.currentMonth = normalizeMonthKey($('monthInput').value || monthNowStr());
      st.currentFY = Number($('fyInput').value || yearNowStr());
      st.currentLeaveTypeId = leaveTypeId;

      st.entries.push({
        id: uuid(),
        staffId,
        date,
        month,
        leaveTypeId,
        d,h,m,
        delta,
        createdAt: Date.now()
      });

      saveState(st);
      clearInput(false);
      render();
    }

    function undoLastForStaff(){
      const st = loadState();
      const staffId = $('staffSelect').value;
      const idx = st.entries
        .map((e,i)=>({e,i}))
        .filter(x=>x.e.staffId===staffId)
        .sort((a,b)=> (b.e.createdAt||0) - (a.e.createdAt||0))[0]?.i;

      if(idx==null) return;
      st.entries.splice(idx,1);
      saveState(st);
      render();
    }

    function duplicateLast(){
      const st = loadState();
      const staffId = $('staffSelect').value;
      const last = st.entries
        .filter(e=>e.staffId===staffId)
        .sort((a,b)=> (b.createdAt||0) - (a.createdAt||0))[0];
      if(!last) return;

      $('dateInput').value = last.date || todayStr();
      $('monthInput').value = normalizeMonthKey(last.month || monthFromDate(last.date || todayStr()));
      $('leaveTypeSelect').value = last.leaveTypeId || 'annual';
      $('in_d').value = String(toInt(last.d));
      $('in_h').value = String(toInt(last.h));
      $('in_m').value = String(toInt(last.m));
      addEntry();
    }

    function deleteEntry(id){
      const st = loadState();
      const idx = st.entries.findIndex(e=>e.id===id);
      if(idx<0) return;
      st.entries.splice(idx, 1);
      saveState(st);
      render();
    }

    function clearInput(focus=true){
      ['in_d','in_h','in_m'].forEach(id=> $(id).value='0');
      if(focus) $('in_d').focus();
    }

    function resetAll(){
      if(!confirm('全職員の履歴をすべて初期化します。よろしいですか？')) return;
      const st = loadState();
      st.entries = [];
      saveState(st);
      render();
    }

    // =========================
    // プリセット
    // =========================
    function setPreset(d,h,m){
      $('in_d').value = String(d);
      $('in_h').value = String(h);
      $('in_m').value = String(m);
      $('in_h').focus();
    }

    // =========================
    // 月・年度ナビ
    // =========================
    function addMonthsToMonthInput(delta){
      const m = normalizeMonthKey($('monthInput').value || monthNowStr());
      const y = Number(m.slice(0,4));
      const mm = Number(m.slice(5,7));
      const dt = new Date(y, mm-1, 1);
      dt.setMonth(dt.getMonth() + delta);
      const next = `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}`;
      $('monthInput').value = next;

      const fy = (dt.getMonth()+1>=4) ? dt.getFullYear() : (dt.getFullYear()-1);
      $('fyInput').value = fy;

      const st = loadState();
      st.currentMonth = normalizeMonthKey(next);
      st.currentFY = fy;
      saveState(st);
      render();
    }
    function shiftFY(delta){
      const fy = Number($('fyInput').value || yearNowStr()) + delta;
      $('fyInput').value = fy;
      const st = loadState();
      st.currentFY = fy;
      saveState(st);
      render();
    }

    // =========================
    // フィルタ
    // =========================
    function updateHistFilters(){
      const st = loadState();
      st.histQuery = $('histQuery').value || '';
      st.histTypeFilter = $('histTypeFilter').value || 'all';
      saveState(st);
      render();
    }
    function clearHistFilters(){
      const st = loadState();
      st.histQuery = '';
      st.histTypeFilter = 'all';
      saveState(st);
      render();
    }
    function updateFYHistFilters(){
      const st = loadState();
      st.fyHistQuery = $('fyHistQuery').value || '';
      st.fyHistTypeFilter = $('fyHistTypeFilter').value || 'all';
      saveState(st);
      render();
    }
    function clearFYHistFilters(){
      const st = loadState();
      st.fyHistQuery = '';
      st.fyHistTypeFilter = 'all';
      saveState(st);
      render();
    }

    // =========================
    // 設定：職員
    // =========================
    function addStaff(){
      const st = loadState();
      const name = ($('newStaffName').value || '').trim();
      if(!name){ alert('職員名を入力してください'); return; }
      if(st.staff.length>=50){ alert('職員は最大50人です'); return; }
      const dup = st.staff.some(s=> s.name===name);
      if(dup && !confirm('同じ名前の職員が既にいます。登録しますか？')) return;

      const id = uuid();
      st.staff.push({id, name});
      st.currentStaffId = id;
      $('newStaffName').value = '';
      saveState(st);
      render();
    }

    function saveStaffName(id){
      const st = loadState();
      const input = document.querySelector(`input[data-staff-name="${CSS.escape(id)}"]`);
      if(!input) return;
      const name = (input.value || '').trim();
      if(!name){ alert('職員名は空にできません'); return; }
      const staff = st.staff.find(s=>s.id===id);
      if(!staff) return;
      staff.name = name;
      saveState(st);
      render();
    }

    function deleteStaff(id){
      const st = loadState();
      if(st.staff.length<=1){ alert('最低1人は必要です'); return; }
      const staff = st.staff.find(s=>s.id===id);
      if(!staff) return;

      const used = st.entries.some(e=>e.staffId===id);
      const msg = used
        ? `「${staff.name}」を削除します。この職員の入力データもすべて削除されます。よろしいですか？`
        : `「${staff.name}」を削除します。よろしいですか？`;
      if(!confirm(msg)) return;

      st.staff = st.staff.filter(s=>s.id!==id);
      st.entries = st.entries.filter(e=>e.staffId!==id);

      if(!st.staff.some(s=>s.id===st.currentStaffId)){
        st.currentStaffId = st.staff[0].id;
      }
      saveState(st);
      render();
    }

    // =========================
    // 設定：種別
    // =========================
    function addType(){
      const st = loadState();
      const name = ($('newTypeName').value || '').trim();
      if(!name){ alert('種別名を入力してください'); return; }
      const dup = st.leaveTypes.some(t=> t.name===name);
      if(dup && !confirm('同じ名称の種別が既にあります。追加しますか？')) return;

      const id = 't_' + shortId();
      st.leaveTypes.push({id, name});
      const vis = visibleCols(st);
      if(vis.length < 4) st.visibleTypeIds = [...vis, id];
      st.currentLeaveTypeId = id;

      $('newTypeName').value = '';
      saveState(st);
      render();
    }

    function saveTypeName(id){
      const st = loadState();
      const input = document.querySelector(`input[data-type-name="${CSS.escape(id)}"]`);
      if(!input) return;
      const name = (input.value || '').trim();
      if(!name){ alert('種別名は空にできません'); return; }
      const type = st.leaveTypes.find(t=>t.id===id);
      if(!type) return;
      type.name = name;
      saveState(st);
      render();
    }

    function deleteType(id){
      const st = loadState();
      const type = st.leaveTypes.find(t=>t.id===id);
      if(!type) return;

      const used = st.entries.some(e=> (e.leaveTypeId||'annual')===id);
      const msg = used
        ? `「${type.name}」を削除します。該当する記録は「不明」として扱われます（データ自体は残ります）。よろしいですか？`
        : `「${type.name}」を削除します。よろしいですか？`;
      if(!confirm(msg)) return;

      st.leaveTypes = st.leaveTypes.filter(t=>t.id!==id);
      st.visibleTypeIds = (st.visibleTypeIds || []).filter(x=>x!==id);

      if(!st.leaveTypes.some(t=>t.id===st.currentLeaveTypeId)){
        st.currentLeaveTypeId = st.leaveTypes[0]?.id || 'annual';
      }
      saveState(st);
      render();
    }

    // =========================
    // 一覧表示列（最大4）
    // =========================
    function toggleVisibleType(id, checked){
      const st = loadState();
      const current = new Set(visibleCols(st));
      if(checked){
        if(current.size>=4){
          alert('一覧に表示できる種別は最大4つです。');
          render();
          return;
        }
        current.add(id);
      }else{
        current.delete(id);
      }
      st.visibleTypeIds = Array.from(current);
      saveState(st);
      render();
    }

    // =========================
    // Modal（内訳）
    // =========================
    function openModal(title, hint, rows, totalMin){
      $('modalTitle').textContent = title;
      $('modalHint').textContent = hint || '';
      $('modalTotal').textContent = `${fmtMin(totalMin)}（${totalMin}分）`;

      const tbody = $('modalBody');
      tbody.innerHTML = '';
      rows.forEach((r, i)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="center">${i+1}</td>
          <td>${typeBadgeHtml(rows._st, r.typeId)}</td>
          <td class="nowrap">${fmtMin(r.min)}</td>
          <td class="nowrap">${r.min}</td>
        `;
        tbody.appendChild(tr);
      });
      setCellLabels(tbody, ['#','種別','表示','分']);

      $('modalOverlay').style.display = 'flex';
      $('modalOverlay').setAttribute('aria-hidden','false');

      $('modalCopyBtn').onclick = ()=>{
        const lines = [];
        lines.push(title);
        rows.forEach(r=>{
          const name = getType(rows._st, r.typeId).name;
          lines.push(`${name}：${fmtMin(r.min)}（${r.min}分）`);
        });
        lines.push(`合計：${fmtMin(totalMin)}（${totalMin}分）`);
        navigator.clipboard.writeText(lines.join('\n')).then(()=>{
          const btn = $('modalCopyBtn'); const old=btn.textContent;
          btn.textContent='コピーしました';
          setTimeout(()=>btn.textContent=old, 1200);
        }).catch(()=>{});
      };
    }
    function closeModal(){
      $('modalOverlay').style.display = 'none';
      $('modalOverlay').setAttribute('aria-hidden','true');
    }

    function showDetailForStaffMonth(st, staffId, month){
      const staff = st.staff.find(s=>s.id===staffId) || {name:'（不明）'};
      const mk = normalizeMonthKey(month);
      const rows = st.leaveTypes.map(t=>{
        const min = totalForMonthType(st, staffId, mk, t.id);
        return {typeId: t.id, min};
      });
      rows._st = st;
      const totalMin = totalForMonthAllTypes(st, staffId, mk);
      openModal(`【${mk}】${staff.name} 内訳（分）`, '※一覧に表示していない種別も含めて表示しています。', rows, totalMin);
    }

    function showDetailAllMonth(st, month){
      const mk = normalizeMonthKey(month);
      const rows = st.leaveTypes.map(t=>{
        const min = st.staff.reduce((acc,s)=> acc + totalForMonthType(st, s.id, mk, t.id), 0);
        return {typeId: t.id, min};
      });
      rows._st = st;
      const totalMin = totalAllStaffMonthAllTypes(st, mk);
      openModal(`【${mk}】全職員 内訳（分）`, '※一覧に表示していない種別も含めて表示しています。', rows, totalMin);
    }

    function showDetailFYAll(st, fy){
      const rows = st.leaveTypes.map(t=>{
        const min = st.staff.reduce((acc,s)=> acc + totalForFYType(st, s.id, fy, t.id), 0);
        return {typeId: t.id, min};
      });
      rows._st = st;
      const totalMin = totalAllStaffFYAllTypes(st, fy);
      openModal(`【${fy}年度】全職員 内訳（分）`, '※一覧に表示していない種別も含めて表示しています。', rows, totalMin);
    }

    // =========================
    // CSV/Excel/JSON（※省略せず全部そのまま：前回版と同等）
    // =========================
    function ensureXLSX(){
      if(typeof XLSX==='undefined'){
        alert('Excel出力ライブラリの読み込みに失敗しました。ネットワーク接続をご確認ください。');
        return false;
      }
      return true;
    }
    function downloadCSV(csv, filename){
      const blob = new Blob([csv], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    function exportIndividualCSV(){
      const st = loadState();
      const staffId = $('staffSelect').value;
      const staff = st.staff.find(s=>s.id===staffId) || {name:'unknown'};
      const month = normalizeMonthKey($('monthInput').value || monthNowStr());
      const list = entriesForMonth(st, staffId, month).slice().reverse();

      const rows = [
        ['月', month],
        ['職員名', staff.name],
        [],
        ['#','日付','種別','追加（日）','追加（時）','追加（分）','追加（分）']
      ];
      list.forEach((e,i)=>{
        const t = getType(st, e.leaveTypeId||'annual').name;
        rows.push([i+1, e.date||'', t, toInt(e.d), toInt(e.h), toInt(e.m), toInt(e.delta)]);
      });

      const csv = rows.map(r=> r.map(x=> `"${String(x).replace(/"/g,'""')}"`).join(',')).join('\r\n');
      downloadCSV(csv, `leave_time_${month}_${staff.name}.csv`);
    }

    function exportAllCSV(){
      const st = loadState();
      const month = normalizeMonthKey($('monthInput').value || monthNowStr());
      const cols = st.leaveTypes;

      const header = ['#','職員名', ...cols.map(t=>`${t.name}（分）`), '合計（分）', '合計（表示）'];
      const rows = [
        ['月', month],
        [],
        header
      ];

      st.staff.forEach((s,i)=>{
        const parts = cols.map(t=> totalForMonthType(st, s.id, month, t.id));
        const sum = parts.reduce((a,b)=>a+b,0);
        rows.push([i+1, s.name, ...parts, sum, fmtMin(sum)]);
      });

      const csv = rows.map(r=> r.map(x=> `"${String(x).replace(/"/g,'""')}"`).join(',')).join('\r\n');
      downloadCSV(csv, `leave_time_all_${month}.csv`);
    }

    function exportIndividualXlsx(){
      if(!ensureXLSX()) return;
      const st = loadState();
      const staffId = $('staffSelect').value;
      const staff = st.staff.find(s=>s.id===staffId) || {name:'unknown'};
      const month = normalizeMonthKey($('monthInput').value || monthNowStr());
      const fy = Number($('fyInput').value || yearNowStr());
      const cols = st.leaveTypes;

      const list = entriesForMonth(st, staffId, month).slice().reverse();
      const aoa1 = [
        ['月', month],
        ['職員名', staff.name],
        [],
        ['#','日付','種別','追加（日）','追加（時）','追加（分）','追加（分）']
      ];
      list.forEach((e,i)=>{
        const t = getType(st, e.leaveTypeId||'annual').name;
        aoa1.push([i+1, e.date||'', t, toInt(e.d), toInt(e.h), toInt(e.m), toInt(e.delta)]);
      });

      const aoa2 = [
        ['年度', `${fy}年度`],
        ['職員名', staff.name],
        [],
        ['月', ...cols.flatMap(t=>[`${t.name}（分）`, `${t.name}（表示）`]), '合計（分）','合計（表示）']
      ];
      fyMonthKeys(fy).forEach(mkey=>{
        const parts = cols.map(t=> totalForMonthType(st, staffId, mkey, t.id));
        const sum = parts.reduce((a,b)=>a+b,0);
        const row = [mkey];
        parts.forEach(v=> row.push(v, fmtMin(v)));
        row.push(sum, fmtMin(sum));
        aoa2.push(row);
      });

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(aoa1), '個別_月内履歴');
      XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(aoa2), '個別_年度月別内訳');
      XLSX.writeFile(wb, `leave_time_${month}_${staff.name}.xlsx`);
    }

    function exportAllXlsx(){
      if(!ensureXLSX()) return;
      const st = loadState();
      const month = normalizeMonthKey($('monthInput').value || monthNowStr());
      const cols = st.leaveTypes;

      const aoa = [
        ['月', month],
        [],
        ['#','職員名', ...cols.flatMap(t=>[`${t.name}（分）`, `${t.name}（表示）`]), '合計（分）','合計（表示）']
      ];

      st.staff.forEach((s,i)=>{
        const parts = cols.map(t=> totalForMonthType(st, s.id, month, t.id));
        const sum = parts.reduce((a,b)=>a+b,0);
        const row = [i+1, s.name];
        parts.forEach(v=> row.push(v, fmtMin(v)));
        row.push(sum, fmtMin(sum));
        aoa.push(row);
      });

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(aoa), '全職員_月一覧');
      XLSX.writeFile(wb, `leave_time_all_${month}.xlsx`);
    }

    function exportFYXlsx(){
      if(!ensureXLSX()) return;
      const st = loadState();
      const fy = Number($('fyInput').value || yearNowStr());
      const staffId = $('staffSelect').value;
      const staff = st.staff.find(s=>s.id===staffId) || {name:'unknown'};
      const cols = st.leaveTypes;

      const aoa1 = [
        ['年度', `${fy}年度`],
        [],
        ['#','職員名', ...cols.flatMap(t=>[`${t.name}（分）`, `${t.name}（表示）`]), '合計（分）','合計（表示）']
      ];
      st.staff.forEach((s,i)=>{
        const parts = cols.map(t=> totalForFYType(st, s.id, fy, t.id));
        const sum = parts.reduce((a,b)=>a+b,0);
        const row = [i+1, s.name];
        parts.forEach(v=> row.push(v, fmtMin(v)));
        row.push(sum, fmtMin(sum));
        aoa1.push(row);
      });

      const aoa2 = [
        ['年度', `${fy}年度`],
        ['職員名', staff.name],
        [],
        ['月', ...cols.flatMap(t=>[`${t.name}（分）`, `${t.name}（表示）`]), '合計（分）','合計（表示）']
      ];
      fyMonthKeys(fy).forEach(mkey=>{
        const parts = cols.map(t=> totalForMonthType(st, staffId, mkey, t.id));
        const sum = parts.reduce((a,b)=>a+b,0);
        const row = [mkey];
        parts.forEach(v=> row.push(v, fmtMin(v)));
        row.push(sum, fmtMin(sum));
        aoa2.push(row);
      });

      const list = entriesForFY(st, staffId, fy).slice().reverse();
      const aoa3 = [
        ['年度', `${fy}年度`],
        ['職員名', staff.name],
        [],
        ['#','日付','月','種別','追加（日）','追加（時）','追加（分）','追加（分）']
      ];
      list.forEach((e,i)=>{
        const t = getType(st, e.leaveTypeId||'annual').name;
        aoa3.push([i+1, e.date||'', normalizeMonthKey(e.month)||'', t, toInt(e.d), toInt(e.h), toInt(e.m), toInt(e.delta)]);
      });

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(aoa1), '全職員_年度合計');
      XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(aoa2), '選択職員_月別内訳');
      XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(aoa3), '選択職員_年度内履歴');
      XLSX.writeFile(wb, `leave_time_fy_${fy}.xlsx`);
    }

    function exportJSON(){
      const st = loadState();
      const blob = new Blob([JSON.stringify(st, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `leave_time_backup_${todayStr()}.json`;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    function importJSON(file){
      const reader = new FileReader();
      reader.onload = ()=>{
        try{
          const obj = JSON.parse(String(reader.result||''));
          if(!obj || !Array.isArray(obj.staff) || !Array.isArray(obj.entries)){
            alert('JSON形式が不正です（staff/entries が必要）');
            return;
          }
          if(!confirm('JSONを復元します。現在の端末内データは置き換えられます。よろしいですか？')) return;

          obj.version = VERSION;
          if(!Array.isArray(obj.leaveTypes) || obj.leaveTypes.length===0) obj.leaveTypes = defaultTypes();
          obj.entries = obj.entries.map(e=>({
            ...e,
            month: normalizeMonthKey(e.month || (e.date ? monthFromDate(e.date) : monthNowStr())),
            leaveTypeId: e.leaveTypeId || 'annual',
            delta: toInt(e.delta),
            d: toInt(e.d),
            h: toInt(e.h),
            m: toInt(e.m),
            createdAt: e.createdAt || Date.now()
          }));
          if(!Array.isArray(obj.visibleTypeIds)) obj.visibleTypeIds = defaultVisibleTypes();
          saveState(obj);
          render();
          alert('復元しました。');
        }catch(e){
          alert('JSONの読み込みに失敗しました');
        }
      };
      reader.readAsText(file);
    }

    function wipeOnlyEntries(){
      if(!confirm('履歴（入力データ）のみ全消去します。職員・種別設定は残します。よろしいですか？')) return;
      const st = loadState();
      st.entries = [];
      saveState(st);
      render();
    }

    // =========================
    // イベント
    // =========================
    $('tabIndividual').addEventListener('click', ()=> setTab('individual'));
    $('tabAll').addEventListener('click', ()=> setTab('all'));
    $('tabFY').addEventListener('click', ()=> setTab('fy'));
    $('tabSettings').addEventListener('click', ()=> setTab('settings'));

    $('staffSelect').addEventListener('change', ()=>{
      const st = loadState();
      st.currentStaffId = $('staffSelect').value;
      saveState(st);
      render();
    });

    $('leaveTypeSelect').addEventListener('change', ()=>{
      const st = loadState();
      st.currentLeaveTypeId = $('leaveTypeSelect').value || 'annual';
      saveState(st);
      render();
    });

    $('dateInput').addEventListener('change', ()=>{
      const d = $('dateInput').value;
      const m = normalizeMonthKey(monthFromDate(d));
      if(m) $('monthInput').value = m;

      if(d){
        const y = Number(d.slice(0,4));
        const mm = Number(d.slice(5,7));
        const fy = (mm>=4) ? y : (y-1);
        $('fyInput').value = fy;
      }

      const st = loadState();
      st.currentMonth = normalizeMonthKey($('monthInput').value || monthNowStr());
      st.currentFY = Number($('fyInput').value || yearNowStr());
      saveState(st);
      render();
    });

    $('monthInput').addEventListener('change', ()=>{
      const st = loadState();
      st.currentMonth = normalizeMonthKey($('monthInput').value || monthNowStr());
      $('monthInput').value = st.currentMonth;

      const y = Number(st.currentMonth.slice(0,4));
      const m = Number(st.currentMonth.slice(5,7));
      const fy = (m>=4) ? y : (y-1);
      $('fyInput').value = fy;

      st.currentFY = fy;
      saveState(st);
      render();
    });

    $('fyInput').addEventListener('change', ()=>{
      const st = loadState();
      st.currentFY = Number($('fyInput').value || yearNowStr());
      saveState(st);
      render();
    });

    $('monthPrevBtn').addEventListener('click', ()=> addMonthsToMonthInput(-1));
    $('monthNextBtn').addEventListener('click', ()=> addMonthsToMonthInput(1));
    $('fyPrevBtn').addEventListener('click', ()=> shiftFY(-1));
    $('fyNextBtn').addEventListener('click', ()=> shiftFY(1));

    $('addBtn').addEventListener('click', addEntry);
    $('undoBtn').addEventListener('click', undoLastForStaff);
    $('duplicateBtn').addEventListener('click', duplicateLast);
    $('clearInputBtn').addEventListener('click', ()=> clearInput(true));
    $('resetAllBtn').addEventListener('click', resetAll);

    $('preset1d').addEventListener('click', ()=> setPreset(1,0,0));
    $('preset1h').addEventListener('click', ()=> setPreset(0,1,0));
    $('preset2h').addEventListener('click', ()=> setPreset(0,2,0));
    $('preset3h').addEventListener('click', ()=> setPreset(0,3,0));
    $('preset4h').addEventListener('click', ()=> setPreset(0,4,0));
    $('preset5h').addEventListener('click', ()=> setPreset(0,5,0));
    $('preset6h').addEventListener('click', ()=> setPreset(0,6,0));
    $('preset7h').addEventListener('click', ()=> setPreset(0,7,0));

    $('histQuery').addEventListener('input', updateHistFilters);
    $('histTypeFilter').addEventListener('change', updateHistFilters);
    $('histClearBtn').addEventListener('click', clearHistFilters);

    $('fyHistQuery').addEventListener('input', updateFYHistFilters);
    $('fyHistTypeFilter').addEventListener('change', updateFYHistFilters);
    $('fyHistClearBtn').addEventListener('click', clearFYHistFilters);

    $('histBody').addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-act="delete"]');
      if(!btn) return;
      deleteEntry(btn.dataset.id);
    });

    // 内訳ボタン（そのまま）
    $('detailMonthBtn').addEventListener('click', ()=>{
      const st = loadState();
      const staffId = $('staffSelect').value;
      const month = normalizeMonthKey($('monthInput').value || monthNowStr());
      showDetailForStaffMonth(st, staffId, month);
    });
    $('detailAllMonthBtn').addEventListener('click', ()=>{
      const st = loadState();
      const month = normalizeMonthKey($('monthInput').value || monthNowStr());
      showDetailAllMonth(st, month);
    });
    $('detailFYBtn').addEventListener('click', ()=>{
      const st = loadState();
      const fy = Number($('fyInput').value || yearNowStr());
      showDetailFYAll(st, fy);
    });

    // 月一覧／年度一覧：行内の内訳（そのまま）
    $('allBody').addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-act="detailStaffMonth"]');
      if(!btn) return;
      const st = loadState();
      const month = normalizeMonthKey($('monthInput').value || monthNowStr());
      showDetailForStaffMonth(st, btn.dataset.id, month);
    });
    $('fyAllBody').addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-act="detailStaffFY"]');
      if(!btn) return;
      const st = loadState();
      const fy = Number($('fyInput').value || yearNowStr());
      const staffId = btn.dataset.id;
      const staff = st.staff.find(s=>s.id===staffId) || {name:'（不明）'};
      const rows = st.leaveTypes.map(t=>({typeId:t.id, min: totalForFYType(st, staffId, fy, t.id)}));
      rows._st = st;
      const totalMin = totalForFYAllTypes(st, staffId, fy);
      openModal(`【${fy}年度】${staff.name} 内訳（分）`, '※一覧に表示していない種別も含めて表示しています。', rows, totalMin);
    });
    $('fyStaffBody').addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-act="detailStaffMonth"]');
      if(!btn) return;
      const st = loadState();
      const month = normalizeMonthKey(btn.dataset.month || $('monthInput').value || monthNowStr());
      showDetailForStaffMonth(st, btn.dataset.id, month);
    });

    // CSV/Excel/JSON
    $('exportIndividualBtn').addEventListener('click', exportIndividualCSV);
    $('exportAllBtn').addEventListener('click', exportAllCSV);
    $('exportIndividualXlsxBtn').addEventListener('click', exportIndividualXlsx);
    $('exportAllXlsxBtn').addEventListener('click', exportAllXlsx);
    $('exportFYXlsxBtn').addEventListener('click', exportFYXlsx);

    $('exportJsonBtn').addEventListener('click', exportJSON);
    $('importJsonInput').addEventListener('change', (e)=>{
      const f = e.target.files && e.target.files[0];
      if(f) importJSON(f);
      e.target.value = '';
    });
    $('wipeOnlyEntriesBtn').addEventListener('click', wipeOnlyEntries);

    // 設定：職員・種別
    $('addStaffBtn').addEventListener('click', addStaff);
    $('newStaffName').addEventListener('keydown', (e)=>{ if(e.key==='Enter') addStaff(); });
    $('staffBody').addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-act]');
      if(!btn) return;
      const act = btn.dataset.act;
      const id = btn.dataset.id;
      if(act==='savestaff') saveStaffName(id);
      if(act==='delstaff') deleteStaff(id);
    });

    $('addTypeBtn').addEventListener('click', addType);
    $('newTypeName').addEventListener('keydown', (e)=>{ if(e.key==='Enter') addType(); });
    $('typeBody').addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-act]');
      if(!btn) return;
      const act = btn.dataset.act;
      const id = btn.dataset.id;
      if(act==='savetype') saveTypeName(id);
      if(act==='deltype') deleteType(id);
    });

    $('visibleTypeBody').addEventListener('change', (e)=>{
      const cb = e.target.closest('input[type="checkbox"][data-act="toggleVisibleType"]');
      if(!cb) return;
      toggleVisibleType(cb.dataset.id, cb.checked);
    });

    // Modal close
    $('modalCloseBtn').addEventListener('click', closeModal);
    $('modalOverlay').addEventListener('click', (e)=>{
      if(e.target === $('modalOverlay')) closeModal();
    });

    // Enter: add（設定入力中は除外）
    document.addEventListener('keydown', (e)=>{
      if(e.key!=='Enter') return;
      const active = document.activeElement;
      const blockIds = new Set(['newStaffName','newTypeName','histQuery','fyHistQuery']);
      if(active && active.id && blockIds.has(active.id)) return;
      if(active && active.closest('#panelSettings')) return;
      addEntry();
    });

    // 初期化
    (function init(){
      const st = loadState();
      $('dateInput').value = todayStr();
      $('monthInput').value = normalizeMonthKey(st.currentMonth || monthNowStr());

      // ★fyInputは年度タブ側にあるが、常に値は保持
      $('fyInput').value = st.currentFY || Number(yearNowStr());

      setTab(st.currentTab || 'individual', false);
      render();
    })();
  </script>
</body>
</html>
