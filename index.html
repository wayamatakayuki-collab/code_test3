<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>休暇時間計算（事務向け：職員別・月別）</title>

  <link rel="apple-touch-icon" href="icon-180.png">
  <link rel="icon" type="image/png" href="icon-180.png">

  <style>
    :root{
      --bg:#f7f7fb;
      --card:#ffffff;
      --ink:#111827;
      --muted:#6b7280;
      --brand:#2563eb;
      --danger:#ef4444;
      --ok:#10b981;
      --ring: 0 0 0 3px rgba(37,99,235,.25);
      --radius: 1.25rem;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN","Yu Gothic UI","Noto Sans JP", sans-serif;
      background: var(--bg);
      color: var(--ink);
      padding: 20px;
    }
    .app{
      width:min(1200px, 100%);
      margin:0 auto;
      background:var(--card);
      border-radius:var(--radius);
      box-shadow: 0 20px 40px rgba(2,6,23,.08), 0 2px 6px rgba(2,6,23,.06);
      overflow:hidden;
    }
    header{padding:18px 20px 12px; border-bottom:1px solid #eee;}
    header h1{margin:0 0 6px; font-size: clamp(18px, 3.4vw, 22px);}
    .wrap{padding: 16px 18px;}
    .grid{display:grid; grid-template-columns: 1.1fr 1fr; gap: 16px;}
    .card{border:1px solid #eee; border-radius:18px; padding:14px; background:#fff;}
    .field label{font-size:12px;color:var(--muted); display:block; margin-bottom:6px}
    input[type=number], input[type=text], input[type=date], input[type=month], select{
      width:100%;
      border:1px solid #e5e7eb;
      border-radius:12px;
      padding:10px 12px;
      font-size:16px;
      outline:none;
      background:white;
    }
    input:focus, select:focus{border-color:var(--brand); box-shadow: var(--ring);}
    .row{display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap}
    .group{display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; align-items:end}
    .actions{display:flex; gap:10px; flex-wrap:wrap}
    button{
      appearance:none; border:0; cursor:pointer;
      padding:10px 14px; border-radius:12px;
      font-size:15px; background:var(--brand); color:white; font-weight:600
    }
    button.secondary{background:#e5e7eb; color:#111827; font-weight:500}
    button.ghost{background:transparent; color:#2563eb}
    button.danger{background:var(--danger); color:white}
    button.ok{background:var(--ok); color:white}
    button:disabled{opacity:.55; cursor:not-allowed}
    .badge{display:inline-flex; gap:6px; align-items:center; background:#eef2ff; color:#3730a3; font-weight:600; padding:6px 10px; border-radius:999px; font-size:12px}
    .pill{display:inline-flex; gap:8px; align-items:center; padding:7px 10px; border:1px solid #e5e7eb; background:#fafafa; border-radius:999px; font-size:12px; color:#374151}
    .result{border:1px dashed #d1d5db; border-radius:14px; padding:12px 14px; background:#fafafa}
    .result .big{font-size: clamp(22px, 4.2vw, 28px); font-weight:800}
    .muted{color:var(--muted)}
    .list{border:1px solid #eee; border-radius:14px; overflow:hidden}
    table{width:100%; border-collapse:collapse; font-size:14px}
    th, td{padding:10px 10px; border-bottom:1px solid #f1f5f9; text-align:left; vertical-align:top}
    th{background:#f8fafc; font-weight:700; font-size:13px}
    tr:hover td{background:#fafafa}
    .center{text-align:center}
    .nowrap{white-space:nowrap}
    .chip{display:inline-block; background:#f3f4f6; border:1px solid #e5e7eb; color:#374151; border-radius:999px; padding:4px 10px; font-size:12px; margin-right:6px}
    .tabs{display:flex; gap:8px; flex-wrap:wrap}
    .tab{
      border:1px solid #e5e7eb;
      background:#fff;
      color:#111827;
      font-weight:700;
      padding:8px 10px;
      border-radius:999px;
      cursor:pointer;
      font-size:13px;
    }
    .tab.active{
      border-color: rgba(37,99,235,.45);
      box-shadow: 0 0 0 3px rgba(37,99,235,.12);
      color:#1d4ed8;
      background:#eef2ff;
    }
    .hint{font-size:12px;color:var(--muted); margin-top:6px; line-height:1.45}
    .footer{padding:14px 18px 18px; color:var(--muted); font-size:12px}
    .divider{height:1px;background:#eef2f7;margin:12px 0}
    .small{font-size:12px}
    .right{margin-left:auto}
    .kpi{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .kpi .box{
      border:1px solid #e5e7eb; background:#fff; border-radius:14px; padding:10px 12px;
      min-width: 180px;
    }
    .kpi .box .t{color:var(--muted); font-size:12px}
    .kpi .box .v{font-size:18px; font-weight:900}
  </style>

  <!-- Responsive enhancement injected (kept) -->
  <style>
    input[type="number"], input[type="text"], select, button { font-size: 16px; line-height: 1.3; }
    button { cursor: pointer; }
    .table-wrap, .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    table { border-collapse: collapse; width: 100%; }
    th, td { padding: 10px; }
    @media (max-width: 720px) {
      .grid, .row, .wrap, .container, .content, .main, .columns, .flex { display: block !important; }
      .card, .panel, .section, .box { width: 100% !important; max-width: 100% !important; margin: 0 0 12px 0 !important; }
      .group, .fields, .controls { display: grid !important; grid-template-columns: 1fr !important; gap: 10px !important; }
      .actions, .buttons { display: grid !important; grid-template-columns: 1fr 1fr; gap: 10px !important; }
      .actions .full, .buttons .full { grid-column: 1 / -1; }
      input, select, button, .btn { width: 100% !important; box-sizing: border-box; }
      [class*="container"], [class*="wrap"] { padding-left: 12px !important; padding-right: 12px !important; }
      .bottom-bar { position: sticky; bottom: 0; z-index: 10; background: rgba(255,255,255,.9); backdrop-filter: saturate(140%) blur(6px); padding: 10px; border-top: 1px solid #e5e7eb; }
      thead th { position: sticky; top: 0; background: #fff; }
    }
  </style>
</head>

<body>
  <main class="app" role="application">
    <header>
      <div class="row" style="align-items:center">
        <div style="flex:1; min-width:240px">
          <h1 style="margin:0;">休暇時間計算アプリ（職員別・月別）</h1>
          <div class="muted small">対象：事務職員／職員登録（最大50）・月別累計・個別/全職員一覧</div>
        </div>
        <span class="badge">1日 = 7時間45分（465分）</span>
      </div>
    </header>

    <div class="wrap grid">
      <!-- 左：入力＆職員管理 -->
      <section class="card">
        <div class="row" style="align-items:flex-end">
          <div class="field" style="flex:1; min-width:220px">
            <label>職員（入力先）</label>
            <select id="staffSelect"></select>
          </div>
          <div class="field" style="min-width:180px">
            <label>日付（この日付の月に計上）</label>
            <input type="date" id="dateInput" />
          </div>
          <div class="field" style="min-width:180px">
            <label>表示中の月</label>
            <input type="month" id="monthInput" />
          </div>
        </div>

        <div class="divider"></div>

        <div class="field"><label>入力（追加する時間）</label></div>
        <div class="group">
          <div class="field"><label>日</label><input type="number" id="in_d" inputmode="numeric" min="0" value="0"></div>
          <div class="field"><label>時間</label><input type="number" id="in_h" inputmode="numeric" min="0" value="0"></div>
          <div class="field"><label>分</label><input type="number" id="in_m" inputmode="numeric" min="0" value="0"></div>
        </div>

        <div class="actions bottom-bar" style="margin-top:12px">
          <button id="addBtn" class="full">追加（この職員に合算）</button>
          <button class="secondary" id="undoBtn">元に戻す</button>
          <button class="secondary" id="clearInputBtn">入力クリア</button>
          <button class="ghost" id="copyBtn">月累計をコピー</button>
          <button class="danger full" id="resetAllBtn">全データ初期化</button>
        </div>

        <div class="result" style="margin-top:12px">
          <div class="kpi">
            <div class="box">
              <div class="t">この職員の月累計</div>
              <div id="totalText" class="v">0日 0時間 0分</div>
            </div>
            <div class="box">
              <div class="t">全職員の月累計（合計）</div>
              <div id="allMonthTotalText" class="v">0日 0時間 0分</div>
            </div>
            <div class="pill right">
              <span class="muted">保存先：</span><b>ブラウザ（localStorage）</b>
            </div>
          </div>

          <div id="totalChips" style="margin-top:8px">
            <span class="chip" id="chipD">日=0</span>
            <span class="chip" id="chipH">時間=0</span>
            <span class="chip" id="chipM">分=0</span>
          </div>

          <div class="hint">
            ・「日付」で計上月が決まります（例：2026-01-25 → 2026-01）<br>
            ・月の切替は「表示中の月」で行えます（一覧/累計も連動します）
          </div>
        </div>

        <div class="divider"></div>

        <!-- 職員登録 -->
        <div class="row" style="align-items:flex-end">
          <div class="field" style="flex:1; min-width:240px">
            <label>職員を追加（最大50人）</label>
            <input type="text" id="newStaffName" placeholder="例）山田 太郎" maxlength="30" />
          </div>
          <button class="ok" id="addStaffBtn" style="min-width:160px">職員を登録</button>
        </div>
        <div class="hint" id="staffCountHint">登録数：0 / 50</div>

        <div class="list" style="margin-top:10px">
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th class="center">#</th>
                  <th>職員名</th>
                  <th class="center nowrap">操作</th>
                </tr>
              </thead>
              <tbody id="staffBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- 右：一覧（個別 / 全職員） -->
      <section class="card">
        <div class="row" style="justify-content:space-between; align-items:center">
          <div class="tabs" role="tablist" aria-label="表示切替">
            <button class="tab active" id="tabIndividual" data-tab="individual" type="button">個別（履歴）</button>
            <button class="tab" id="tabAll" data-tab="all" type="button">全職員（月一覧）</button>
          </div>
          <div class="muted small">月：<span id="monthLabel">----</span></div>
        </div>

        <!-- 個別：履歴 -->
        <div id="panelIndividual" style="margin-top:10px">
          <div class="row" style="align-items:center">
            <div class="pill"><span class="muted">職員：</span><b id="indStaffName">-</b></div>
            <div class="pill"><span class="muted">月累計：</span><b id="indMonthTotal">0日 0時間 0分</b></div>
            <div class="actions right">
              <button class="secondary" id="exportIndividualBtn">個別CSV</button>
            </div>
          </div>

          <div class="list" style="margin-top:10px">
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th class="center">#</th>
                    <th class="nowrap">日付</th>
                    <th>追加</th>
                    <th>月内累計</th>
                    <th class="center">操作</th>
                  </tr>
                </thead>
                <tbody id="histBody"></tbody>
              </table>
            </div>
          </div>
          <div class="hint">※「削除」は月内の該当記録を削除し、月内累計を再計算します。</div>
        </div>

        <!-- 全職員：月一覧 -->
        <div id="panelAll" style="margin-top:10px; display:none">
          <div class="row" style="align-items:center">
            <div class="pill"><span class="muted">全職員 合計：</span><b id="allMonthTotal2">0日 0時間 0分</b></div>
            <div class="actions right">
              <button class="secondary" id="exportAllBtn">全職員CSV</button>
            </div>
          </div>

          <div class="list" style="margin-top:10px">
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th class="center">#</th>
                    <th>職員名</th>
                    <th class="nowrap">月累計</th>
                    <th class="nowrap muted">（分）</th>
                  </tr>
                </thead>
                <tbody id="allBody"></tbody>
              </table>
            </div>
          </div>

          <div class="hint">
            ・この表は「表示中の月」の合計です。<br>
            ・職員名の追加/削除、月の切替に連動します。
          </div>
        </div>
      </section>
    </div>

    <div class="footer">© 休暇時間計算アプリ（事務向け） Takayuki WAYAMA</div>
  </main>

  <script>
    // =========================
    // 設定
    // =========================
    const DAY_MIN = 465;

    // 旧v1（単一累計）→ v2（職員・月別）への移行もする
    const KEY_V1 = 'worktime_accum_v1';         // 旧
    const KEY_V2 = 'worktime_accum_staff_v2';   // 新

    const $ = (id)=>document.getElementById(id);
    const toInt = (v)=>{ const n=parseInt(v,10); return isNaN(n)?0:Math.max(0,n); };
    const totalMinutes = (d,h,m)=> toInt(d)*DAY_MIN + toInt(h)*60 + toInt(m);

    const normalize = (t)=>{
      const d = Math.floor(t / DAY_MIN);
      const rem = t - d*DAY_MIN;
      const h = Math.floor(rem/60);
      const m = rem - h*60;
      return {d,h,m};
    };
    const fmt = (d,h,m)=> `${d}日 ${h}時間 ${m}分`;
    const fmtMin = (t)=>{
      const n = normalize(t);
      return fmt(n.d,n.h,n.m);
    };

    const todayStr = ()=>{
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    };
    const monthFromDate = (dateStr)=>{
      if(!dateStr || dateStr.length<7) return '';
      return dateStr.slice(0,7);
    };
    const monthNowStr = ()=> monthFromDate(todayStr());

    const uuid = ()=> (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()+Math.random()));

    // =========================
    // 状態（localStorage）
    // =========================
    function loadStateV2(){
      // v2があればそれを優先
      try{
        const raw2 = localStorage.getItem(KEY_V2);
        if(raw2){
          const obj = JSON.parse(raw2);
          if(obj && obj.version===2 && Array.isArray(obj.staff) && Array.isArray(obj.entries)){
            // 最低1名は確保
            if(obj.staff.length===0){
              const def = {id: uuid(), name:'（未設定）'};
              obj.staff = [def];
            }
            // currentStaffIdが無効なら先頭
            if(!obj.currentStaffId || !obj.staff.some(s=>s.id===obj.currentStaffId)){
              obj.currentStaffId = obj.staff[0].id;
            }
            if(!obj.currentTab) obj.currentTab = 'individual';
            return obj;
          }
        }
      }catch(e){}

      // v1があれば移行（※日付情報が無いので「今日」で計上）
      try{
        const raw1 = localStorage.getItem(KEY_V1);
        if(raw1){
          const v1 = JSON.parse(raw1);
          if(v1 && typeof v1.sum==='number' && Array.isArray(v1.items)){
            const staffId = uuid();
            const date = todayStr();
            const month = monthFromDate(date);
            const entries = v1.items.map((it, idx)=>({
              id: it.id || uuid(),
              staffId,
              date,
              month,
              d: toInt(it.d),
              h: toInt(it.h),
              m: toInt(it.m),
              delta: toInt(it.delta),
              createdAt: Date.now() + idx
            }));
            const migrated = {
              version: 2,
              staff: [{id: staffId, name: '（旧データ）'}],
              entries,
              currentStaffId: staffId,
              currentMonth: monthNowStr(),
              currentTab: 'individual'
            };
            saveStateV2(migrated);
            return migrated;
          }
        }
      }catch(e){}

      // 新規
      const def = {id: uuid(), name:'（未設定）'};
      const init = {
        version: 2,
        staff: [def],
        entries: [],
        currentStaffId: def.id,
        currentMonth: monthNowStr(),
        currentTab: 'individual'
      };
      saveStateV2(init);
      return init;
    }

    function saveStateV2(state){
      localStorage.setItem(KEY_V2, JSON.stringify(state));
    }

    // =========================
    // 集計
    // =========================
    function entriesFor(st, staffId, month){
      return st.entries
        .filter(e=> e.staffId===staffId && e.month===month)
        .sort((a,b)=> (a.createdAt||0) - (b.createdAt||0));
    }
    function totalFor(st, staffId, month){
      return entriesFor(st, staffId, month).reduce((acc,e)=> acc + toInt(e.delta), 0);
    }
    function totalAllStaff(st, month){
      return st.staff.reduce((acc,s)=> acc + totalFor(st, s.id, month), 0);
    }

    // =========================
    // 描画
    // =========================
    function render(){
      const st = loadStateV2();

      // inputs default
      if(!$('dateInput').value) $('dateInput').value = todayStr();
      if(!$('monthInput').value) $('monthInput').value = st.currentMonth || monthNowStr();

      // month label
      const month = $('monthInput').value || monthNowStr();
      st.currentMonth = month;
      saveStateV2(st);
      $('monthLabel').textContent = month;

      // staff select
      $('staffSelect').innerHTML = '';
      st.staff.forEach(s=>{
        const opt = document.createElement('option');
        opt.value = s.id;
        opt.textContent = s.name;
        if(s.id===st.currentStaffId) opt.selected = true;
        $('staffSelect').appendChild(opt);
      });

      // staff count
      $('staffCountHint').textContent = `登録数：${st.staff.length} / 50`;

      // current staff
      const staff = st.staff.find(x=>x.id===st.currentStaffId) || st.staff[0];
      const staffId = staff.id;

      // totals
      const myTotalMin = totalFor(st, staffId, month);
      const myTotal = normalize(myTotalMin);
      $('totalText').textContent = fmt(myTotal.d, myTotal.h, myTotal.m);
      $('chipD').textContent = `日=${myTotal.d}`;
      $('chipH').textContent = `時間=${myTotal.h}`;
      $('chipM').textContent = `分=${myTotal.m}`;

      const allMin = totalAllStaff(st, month);
      $('allMonthTotalText').textContent = fmtMin(allMin);
      $('allMonthTotal2').textContent = fmtMin(allMin);

      // panels header
      $('indStaffName').textContent = staff.name;
      $('indMonthTotal').textContent = fmtMin(myTotalMin);

      // staff list table
      const sb = $('staffBody');
      sb.innerHTML = '';
      st.staff.forEach((s, idx)=>{
        const tr = document.createElement('tr');
        const delDisabled = (st.staff.length<=1); // 最低1名は残す
        tr.innerHTML = `
          <td class="center">${idx+1}</td>
          <td>
            <div style="font-weight:800">${escapeHtml(s.name)}</div>
            <div class="muted small">ID: ${escapeHtml(s.id.slice(0,8))}...</div>
          </td>
          <td class="center nowrap">
            <button class="secondary" data-act="pick" data-id="${s.id}">選択</button>
            <button class="danger" data-act="delstaff" data-id="${s.id}" ${delDisabled?'disabled':''}>削除</button>
          </td>
        `;
        sb.appendChild(tr);
      });

      // tab
      setTab(st.currentTab || 'individual', false);

      // individual history
      const body = $('histBody');
      body.innerHTML = '';
      const list = entriesFor(st, staffId, month);
      let acc = 0;
      list.forEach((e, i)=>{
        acc += toInt(e.delta);
        const cumul = normalize(acc);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="center">${i+1}</td>
          <td class="nowrap">${escapeHtml(e.date)}</td>
          <td>${fmt(toInt(e.d),toInt(e.h),toInt(e.m))}</td>
          <td>${fmt(cumul.d, cumul.h, cumul.m)}</td>
          <td class="center">
            <button class="secondary" data-act="delete" data-id="${e.id}">削除</button>
          </td>
        `;
        body.appendChild(tr);
      });

      // all staff list
      const ab = $('allBody');
      ab.innerHTML = '';
      st.staff.forEach((s, idx)=>{
        const t = totalFor(st, s.id, month);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="center">${idx+1}</td>
          <td style="font-weight:800">${escapeHtml(s.name)}</td>
          <td class="nowrap">${fmtMin(t)}</td>
          <td class="muted nowrap">${t}</td>
        `;
        ab.appendChild(tr);
      });

      // enable/disable undo (selected staff has entries?)
      const hasAnyForStaff = st.entries.some(e=>e.staffId===staffId);
      $('undoBtn').disabled = !hasAnyForStaff;
    }

    function escapeHtml(s){
      return String(s ?? '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    // =========================
    // 操作：職員
    // =========================
    function addStaff(){
      const st = loadStateV2();
      const name = ($('newStaffName').value || '').trim();
      if(!name){ alert('職員名を入力してください'); return; }
      if(st.staff.length>=50){ alert('職員は最大50人です'); return; }
      const dup = st.staff.some(s=> s.name===name);
      if(dup && !confirm('同じ名前の職員が既にいます。登録しますか？')) return;

      const id = uuid();
      st.staff.push({id, name});
      st.currentStaffId = id;
      saveStateV2(st);
      $('newStaffName').value = '';
      render();
    }

    function pickStaff(id){
      const st = loadStateV2();
      if(!st.staff.some(s=>s.id===id)) return;
      st.currentStaffId = id;
      saveStateV2(st);
      render();
    }

    function deleteStaff(id){
      const st = loadStateV2();
      if(st.staff.length<=1){ alert('最低1人は必要です'); return; }
      const staff = st.staff.find(s=>s.id===id);
      if(!staff) return;

      // 当該職員のデータも削除
      const used = st.entries.some(e=>e.staffId===id);
      const msg = used
        ? `「${staff.name}」を削除します。この職員の入力データもすべて削除されます。よろしいですか？`
        : `「${staff.name}」を削除します。よろしいですか？`;
      if(!confirm(msg)) return;

      st.staff = st.staff.filter(s=>s.id!==id);
      st.entries = st.entries.filter(e=>e.staffId!==id);

      if(!st.staff.some(s=>s.id===st.currentStaffId)){
        st.currentStaffId = st.staff[0].id;
      }
      saveStateV2(st);
      render();
    }

    // =========================
    // 操作：入力・履歴
    // =========================
    function addEntry(){
      const st = loadStateV2();
      const staffId = $('staffSelect').value;
      const date = $('dateInput').value || todayStr();
      const month = monthFromDate(date) || ($('monthInput').value || monthNowStr());

      const d = toInt($('in_d').value);
      const h = toInt($('in_h').value);
      const m = toInt($('in_m').value);
      const delta = totalMinutes(d,h,m);

      if(delta===0){ alert('0は追加されません'); return; }

      st.currentStaffId = staffId;
      st.currentMonth = $('monthInput').value || monthNowStr();

      st.entries.push({
        id: uuid(),
        staffId,
        date,
        month,
        d,h,m,
        delta,
        createdAt: Date.now()
      });

      saveStateV2(st);
      render();
    }

    function undoLastForStaff(){
      const st = loadStateV2();
      const staffId = $('staffSelect').value;
      const list = st.entries
        .map((e, idx)=>({e, idx}))
        .filter(x=> x.e.staffId===staffId)
        .sort((a,b)=> (a.e.createdAt||0) - (b.e.createdAt||0));
      if(list.length===0) return;

      const last = list[list.length-1];
      st.entries.splice(last.idx, 1);
      saveStateV2(st);
      render();
    }

    function deleteEntry(id){
      const st = loadStateV2();
      const idx = st.entries.findIndex(e=>e.id===id);
      if(idx<0) return;
      st.entries.splice(idx, 1);
      saveStateV2(st);
      render();
    }

    function clearInput(){
      ['in_d','in_h','in_m'].forEach(id=> $(id).value='0');
      $('in_d').focus();
    }

    function resetAll(){
      if(!confirm('全職員の累計と履歴をすべて初期化します。よろしいですか？')) return;
      const st = loadStateV2();
      st.entries = [];
      saveStateV2(st);
      render();
    }

    function copyMonthTotal(){
      const st = loadStateV2();
      const staffId = $('staffSelect').value;
      const month = $('monthInput').value || monthNowStr();
      const staff = st.staff.find(s=>s.id===staffId) || {name:'（不明）'};
      const t = totalFor(st, staffId, month);
      const text = `【${month}】${staff.name}：${fmtMin(t)}`;
      navigator.clipboard.writeText(text).then(()=>{
        const btn = $('copyBtn'); const old=btn.textContent;
        btn.textContent='コピーしました';
        setTimeout(()=>btn.textContent=old, 1200);
      }).catch(()=>{});
    }

    // =========================
    // CSV
    // =========================
    function downloadCSV(csv, filename){
      const blob = new Blob([csv], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    function exportIndividualCSV(){
      const st = loadStateV2();
      const staffId = $('staffSelect').value;
      const month = $('monthInput').value || monthNowStr();
      const staff = st.staff.find(s=>s.id===staffId) || {name:'unknown'};
      const list = entriesFor(st, staffId, month);

      let acc = 0;
      const rows = [
        ['月', month],
        ['職員名', staff.name],
        [],
        ['#','日付','追加（日）','追加（時）','追加（分）','追加（分）','月内累計（分）','月内累計（表示）']
      ];

      list.forEach((e, i)=>{
        acc += toInt(e.delta);
        rows.push([
          i+1, e.date,
          toInt(e.d), toInt(e.h), toInt(e.m),
          toInt(e.delta),
          acc,
          fmtMin(acc)
        ]);
      });

      const csv = rows
        .map(r=> r.map(x=> `"${String(x).replace(/"/g,'""')}"`).join(','))
        .join('\r\n');

      downloadCSV(csv, `leave_time_${month}_${staff.name}.csv`);
    }

    function exportAllCSV(){
      const st = loadStateV2();
      const month = $('monthInput').value || monthNowStr();
      const rows = [
        ['月', month],
        [],
        ['#','職員名','月累計（表示）','月累計（分）']
      ];
      st.staff.forEach((s, i)=>{
        const t = totalFor(st, s.id, month);
        rows.push([i+1, s.name, fmtMin(t), t]);
      });
      const sum = totalAllStaff(st, month);
      rows.push([]);
      rows.push(['合計', '', fmtMin(sum), sum]);

      const csv = rows
        .map(r=> r.map(x=> `"${String(x).replace(/"/g,'""')}"`).join(','))
        .join('\r\n');

      downloadCSV(csv, `leave_time_all_${month}.csv`);
    }

    // =========================
    // タブ
    // =========================
    function setTab(tab, persist=true){
      const st = loadStateV2();
      const t = (tab==='all') ? 'all' : 'individual';
      $('tabIndividual').classList.toggle('active', t==='individual');
      $('tabAll').classList.toggle('active', t==='all');
      $('panelIndividual').style.display = (t==='individual') ? '' : 'none';
      $('panelAll').style.display = (t==='all') ? '' : 'none';
      if(persist){
        st.currentTab = t;
        saveStateV2(st);
      }
    }

    // =========================
    // イベント
    // =========================
    $('addStaffBtn').addEventListener('click', addStaff);
    $('newStaffName').addEventListener('keydown', (e)=>{ if(e.key==='Enter') addStaff(); });

    $('staffSelect').addEventListener('change', ()=>{
      const st = loadStateV2();
      st.currentStaffId = $('staffSelect').value;
      saveStateV2(st);
      render();
    });

    $('dateInput').addEventListener('change', ()=>{
      // 日付を変えたら、月表示もその月に合わせる（使いやすさ優先）
      const m = monthFromDate($('dateInput').value);
      if(m) $('monthInput').value = m;
      const st = loadStateV2();
      st.currentMonth = $('monthInput').value || monthNowStr();
      saveStateV2(st);
      render();
    });

    $('monthInput').addEventListener('change', ()=>{
      const st = loadStateV2();
      st.currentMonth = $('monthInput').value || monthNowStr();
      saveStateV2(st);
      render();
    });

    $('addBtn').addEventListener('click', addEntry);
    $('undoBtn').addEventListener('click', undoLastForStaff);
    $('clearInputBtn').addEventListener('click', clearInput);
    $('resetAllBtn').addEventListener('click', resetAll);
    $('copyBtn').addEventListener('click', copyMonthTotal);

    $('exportIndividualBtn').addEventListener('click', exportIndividualCSV);
    $('exportAllBtn').addEventListener('click', exportAllCSV);

    $('tabIndividual').addEventListener('click', ()=> setTab('individual'));
    $('tabAll').addEventListener('click', ()=> setTab('all'));

    $('staffBody').addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-act]');
      if(!btn) return;
      const act = btn.dataset.act;
      const id = btn.dataset.id;
      if(act==='pick') pickStaff(id);
      if(act==='delstaff') deleteStaff(id);
    });

    $('histBody').addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-act="delete"]');
      if(!btn) return;
      deleteEntry(btn.dataset.id);
    });

    document.addEventListener('keydown', (e)=>{
      // 入力中に Enter で追加（ただし職員名入力欄は除外）
      const active = document.activeElement;
      if(e.key==='Enter' && active && active.id!=='newStaffName'){
        addEntry();
      }
    });

    // 初期化
    (function init(){
      const st = loadStateV2();
      // inputs
      $('dateInput').value = todayStr();
      $('monthInput').value = st.currentMonth || monthNowStr();
      $('monthLabel').textContent = $('monthInput').value;
      setTab(st.currentTab || 'individual', false);
      render();
    })();
  </script>
</body>
</html>
